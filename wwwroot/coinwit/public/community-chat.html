<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C·ªông ƒê·ªìng - CoinWit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="main.js"></script>
    
    <style>
        :root {
            /* ƒê·ªìng b·ªô ho√†n to√†n v·ªõi index.html */
            --dark-bg: #0a0a0e;
            --card-bg: #1a1b20;
            --border-color: #2b2d35;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0; 
            --yellow-accent: #facc15;
            
            /* Bi·∫øn m√†u ri√™ng cho chat, d·ª±a tr√™n m√†u ch·ªß ƒë·∫°o */
            --bubble-me-bg: #facc15;
            --bubble-me-text: #0a0a0e;
            --bubble-other-bg: #2b2d35;
            --bubble-other-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            /* [FIX] ƒê·∫£m b·∫£o body kh√¥ng bao gi·ªù cu·ªôn */
            overflow: hidden;
            width: 100vw;
            max-width: 100vw; /* NgƒÉn m·ªü r·ªông ngang */
        }
        
        /* NgƒÉn cu·ªôn ngang to√†n trang */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Hi·ªÉn th·ªã thanh cu·ªôn */
        #chat-messages {
            -ms-overflow-style: auto;
        }
        
        .chat-bubble {
            max-width: 75%; /* [FIX] Ch·ªëng v·ª° layout, t·ª± xu·ªëng d√≤ng */
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word; /* [FIX] B·∫Øt bu·ªôc ph·∫£i c√≥ */
            white-space: pre-wrap; /* Cho ph√©p xu·ªëng d√≤ng */
            overflow-wrap: break-word; /* NgƒÉn tr√†n ngang */
        }
        
        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            flex-shrink: 0;
            overflow: hidden; /* Hi·ªÉn th·ªã ƒë√∫ng avatar d·∫°ng ·∫£nh, kh√¥ng tr√†n ra ngo√†i */
        }
        
        .leader-badge {
            background: linear-gradient(135deg, #facc15, #f59e0b);
            color: #0a0a0e;
            padding: 0.15rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.65rem;
            font-weight: bold;
            margin-left: 0.5rem;
            display: inline-block;
        }
        
        /* Tin nh·∫Øn c·ªßa t√¥i */
        .chat-bubble.me {
            background-color: var(--bubble-me-bg);
            color: var(--bubble-me-text);
            border-bottom-right-radius: 0.5rem;
            align-self: flex-end;
        }
        
        /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c */
        .chat-bubble.other {
            background-color: var(--bubble-other-bg);
            color: var(--bubble-other-text);
            border-bottom-left-radius: 0.5rem;
            align-self: flex-start;
        }
        
        .chat-bubble img {
            max-width: 100%;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
        }

        .input-chat {
            background-color: var(--bubble-other-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 99px;
            padding: 0.75rem 1.25rem;
        }
        .input-chat:focus {
            outline: none;
            border-color: var(--yellow-accent);
        }
        
        .btn-icon {
            background-color: var(--bubble-other-bg);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn-icon:hover {
            background-color: var(--border-color);
            color: var(--yellow-accent);
        }
        
        .btn-send {
            background-color: var(--yellow-accent);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn-send:hover {
            filter: brightness(1.1);
        }
        
        /* ======================================= */
        /* [M·ªöI] N√ÇNG C·∫§P ƒê·ªí H·ªåC V5 (Ch·ªânh chu) */
        /* ======================================= */
        
        body {
            /* N√¢ng c·∫•p n·ªÅn "Nghi√™m t√∫c" */
            background: radial-gradient(ellipse at center, #1a1b20 0%, var(--dark-bg) 70%);
        }
        
        /* Header v√† Footer (Thanh nh·∫≠p li·ªáu) */
        header, footer {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            backdrop-filter: blur(10px);
            background-color: rgba(26, 27, 32, 0.75); /* 75% m·ªù */
            border-width: 1px;
        }

        header {
            position: sticky; /* Gi·ªØ header c·ªë ƒë·ªãnh */
            top: 0;
            z-index: 10;
        }

        footer {
            position: sticky; /* Gi·ªØ thanh chat c·ªë ƒë·ªãnh */
            bottom: 0;
            z-index: 10;
        }

        /* N·ªÅn khu v·ª±c chat */
        #chat-messages {
            background: radial-gradient(ellipse at bottom, #111317 0%, var(--dark-bg) 70%);
            padding-bottom: 70px; /* Add extra padding at the bottom */
            overflow-x: hidden; /* NgƒÉn cu·ªôn ngang */
        }
        
        /* Bong b√≥ng chat */
        .chat-bubble {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 85%; /* Gi·ªõi h·∫°n t·ªëi ƒëa chi·ªÅu r·ªông bong b√≥ng */
        }
        
        /* Tin nh·∫Øn c·ªßa t√¥i (V√†ng gradient) */
        .chat-bubble.me {
            background: linear-gradient(145deg, #fde047, var(--yellow-accent));
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.15);
            font-weight: 500;
        }
        
        /* [N√ÇNG C·∫§P] Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c (Gradient t·ªëi) */
        .chat-bubble.other {
            background: linear-gradient(145deg, #32353f, var(--bubble-other-bg));
        }
        
        /* [N√ÇNG C·∫§P] Avatar (B·ªè shadow/border c·ª©ng, d√πng JS) */
        .avatar {
            border: 1px solid rgba(255, 255, 255, 0.05); /* Th√™m vi·ªÅn si√™u m·ªèng */
            /* box-shadow s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông b·∫±ng JS */
        }
        
        /* √î nh·∫≠p li·ªáu */
        .input-chat {
            background-color: var(--dark-bg); /* T·ªëi h∆°n 1 ch√∫t */
            border-color: var(--border-color);
            transition: all 0.2s ease;
            max-width: 100%; /* NgƒÉn tr√†n ngang */
        }
        .input-chat:focus {
            border-color: var(--yellow-accent);
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.2);
        }
        
        /* N√∫t icon (·∫¢nh, G·ª≠i) */
        .btn-icon, .btn-send {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-icon {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
        }
        .btn-icon:hover {
            background-color: var(--border-color);
            border-color: var(--yellow-accent);
        }
        .btn-send:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        
        /* [M·ªöI] Th√™m thanh cu·ªôn ƒë·∫πp */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: #4a4d5e;
        }
        #chat-messages {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--dark-bg);
        }
        
        /* [N√ÇNG C·∫§P] Animation cho tin nh·∫Øn m·ªõi (gi·ªëng Messenger) */
        .message-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
    </style>
</head>
<body class="flex flex-col h-screen max-w-screen overflow-hidden">

    <header class="flex-shrink-0 flex items-center justify-between p-4 border-b" style="background-color: var(--card-bg); border-color: var(--border-color);">
        <a href="index" class="text-white">
            <i class="fas fa-arrow-left text-xl"></i>
        </a>
        <div class="text-center">
            <h1 class="text-lg font-bold text-white">C·ªông ƒê·ªìng</h1>
            <p class="text-xs text-gray-400">
                <span id="user-count">0</span> ng∆∞·ªùi ƒëang ho·∫°t ƒë·ªông
            </p>
        </div>
        <div class="w-6"></div>
    </header>

    <main id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 pb-20 overflow-x-hidden">
        </main>

    <footer class="flex-shrink-0 flex items-center p-4 overflow-hidden" style="background-color: var(--card-bg);">
        <button id="upload-btn" class="btn-icon mr-2 flex-shrink-0">
            <i class="fas fa-image text-xl"></i>
        </button>
        <input type="file" id="image-input" hidden accept="image/*">
        
        <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." class="input-chat w-full block">
        
        <button id="send-btn" class="btn-send ml-2 flex-shrink-0">
            <i class="fas fa-paper-plane text-xl"></i>
        </button>
    </footer>

<script>
    // ==========================================================
    // KHU V·ª∞C CHAT TH·∫¨T (REAL-TIME V5 - N√ÇNG C·∫§P ƒê·ªí H·ªåC)
    // ==========================================================
    
    // --- DOM Elements ---
    const chatMessagesEl = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const imageInput = document.getElementById('image-input');
    const userCountEl = document.getElementById('user-count');
    
    let MY_USER_ID = null;
    let MY_USERNAME = 'B·∫°n';
    let MY_AVATAR_URL = null;
    let socket = null;

    // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc ·∫£nh t·∫£i l√™n (MB)
    const MAX_IMAGE_SIZE_MB = 2; // ch·ªânh n·∫øu backend cho ph√©p l·ªõn h∆°n
    const MAX_IMAGE_SIZE_BYTES = MAX_IMAGE_SIZE_MB * 1024 * 1024;
    
    // === C√°c h√†m Helper (Gi·ªØ nguy√™n) ===
    const avatarColors = [
        '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
        '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
        '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
        '#ec4899', '#f43f5e'
    ];
    
    function getAvatar(username, isLeader = false) {
        if (isLeader) return 'üëë';
        const emojis = ['üòé', 'ü§ë', 'üí∞', 'üé∞', 'üé≤', 'üî•', 'üíé', '‚≠ê', 'üöÄ', 'üí∏', 'üéØ', 'üëä', 'üòà', 'ü§©', 'ü•≥', 'üò§'];
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        return emojis[Math.abs(hash) % emojis.length];
    }
    
    function getAvatarColor(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        return avatarColors[Math.abs(hash) % avatarColors.length];
    }

    function scrollToBottom(force = false) {
        // Always scroll to bottom with a small delay to ensure DOM is updated
        setTimeout(() => {
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }, 50);
    }
    
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });
    }

    /**
     * [FIX 1] Th√™m h√†m jwt_decode (v√¨ main.js kh√¥ng cung c·∫•p)
     */
    function jwt_decode(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('L·ªói gi·∫£i m√£ token:', e);
            return null;
        }
    }

    /**
     * T·∫°o element avatar, ∆∞u ti√™n d√πng avatar URL th·ª±c n·∫øu c√≥
     */
    function buildAvatarElement(msg, isMe) {
        const avatarEl = document.createElement('div');
        avatarEl.className = 'avatar';

        const avatarUrl = msg.avatar || (isMe ? MY_AVATAR_URL : null);
        if (avatarUrl) {
            avatarEl.style.backgroundColor = 'transparent';
            avatarEl.style.boxShadow = '0 0 12px rgba(0,0,0,0.4)';

            const img = document.createElement('img');
            img.src = avatarUrl;
            img.alt = msg.username || '';
            img.className = 'w-full h-full object-cover';
            avatarEl.appendChild(img);
        } else {
            const color = getAvatarColor(msg.username);
            avatarEl.style.backgroundColor = color;
            avatarEl.style.boxShadow = `0 0 12px ${color}40`;
            avatarEl.textContent = getAvatar(msg.username, msg.isLeader);
        }
        return avatarEl;
    }

    /**
     * H√†m ch√≠nh ƒë·ªÉ th√™m tin nh·∫Øn v√†o giao di·ªán
     */
    function addMessageToUI(msg, isNew) {
        const ts = msg.timestamp ? new Date(msg.timestamp).getTime() : Date.now();
        const key = msg.id ? `${msg.id}-${ts}` : `tmp-${ts}`;
        if (document.getElementById(`chat-msg-${key}`)) {
            return;
        }

        const isMe = (String(msg.userId) === String(MY_USER_ID));
        
        const messageWrapper = document.createElement('div');
        // [FIX] 'w-full' l√† b·∫Øt bu·ªôc ƒë·ªÉ bong b√≥ng chat cƒÉn l·ªÅ ƒë√∫ng
        messageWrapper.className = `flex ${isMe ? 'flex-row-reverse' : 'flex-row'} items-start gap-2 w-full`;
        messageWrapper.id = `chat-msg-${key}`;
        
        // [N√ÇNG C·∫§P] Th√™m class animation n·∫øu l√† tin nh·∫Øn m·ªõi
        if (isNew) {
            messageWrapper.classList.add('message-fade-in');
        }

        // Avatar cho c·∫£ t√¥i v√† ng∆∞·ªùi kh√°c (∆∞u ti√™n avatar th·∫≠t n·∫øu c√≥)
        const avatarEl = buildAvatarElement(msg, isMe);
        messageWrapper.appendChild(avatarEl);
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} w-full max-w-[85%]`;
        const messageBubble = document.createElement('div');
        messageBubble.className = `chat-bubble ${isMe ? 'me' : 'other'} w-full break-words`;
        if (!isMe) {
            const headerEl = document.createElement('div');
            headerEl.className = 'flex items-center mb-1';
            const usernameEl = document.createElement('span');
            usernameEl.className = 'font-bold text-sm';
            usernameEl.style.color = 'var(--yellow-accent)';
            usernameEl.textContent = msg.username;
            headerEl.appendChild(usernameEl);
            if (msg.isLeader) {
                const badgeEl = document.createElement('span');
                badgeEl.className = 'leader-badge';
                badgeEl.textContent = 'LEADER';
                headerEl.appendChild(badgeEl);
            }
            messageBubble.appendChild(headerEl);
        }
        if (msg.isImage) {
            const img = document.createElement('img');
            img.src = msg.message;
            img.className = 'rounded-lg max-w-full max-h-[250px] object-contain';
            img.onload = () => {
                if (isNew) scrollToBottom();
            };
            messageBubble.appendChild(img);
        } else {
            // [S·ª¨A L·ªñI HI·ªÇN TH·ªä] Ch·ªâ d√πng <pre> cho tin nh·∫Øn c·ªßa NG∆Ø·ªúI KH√ÅC
            if (isMe) {
                const textEl = document.createElement('div');
                textEl.textContent = msg.message; // Tin c·ªßa m√¨nh d√πng div
                textEl.className = 'break-words'; // NgƒÉn tr√†n ngang
                messageBubble.appendChild(textEl);
            } else {
                const textEl = document.createElement('div');
                textEl.innerHTML = `<pre style="font-family: inherit; font-size: inherit; white-space: pre-wrap; word-wrap: break-word;">${escapeHTML(msg.message)}</pre>`;
                textEl.className = 'break-words'; // NgƒÉn tr√†n ngang
                messageBubble.appendChild(textEl);
            }
        }
        const timeEl = document.createElement('div');
        timeEl.className = `text-xs mt-1 ${isMe ? 'text-gray-800' : 'text-gray-400'} opacity-75`;
        timeEl.textContent = new Date(msg.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        contentWrapper.appendChild(messageBubble);
        contentWrapper.appendChild(timeEl);
        messageWrapper.appendChild(contentWrapper);
        chatMessagesEl.appendChild(messageWrapper);
        if (isNew) {
            scrollToBottom();
        }
    }

    /**
     * G·ª≠i tin nh·∫Øn vƒÉn b·∫£n
     */
    function handleSend() {
        const messageText = messageInput.value.trim();
        // Kh√¥ng g·ª≠i n·∫øu r·ªóng ho·∫∑c ch∆∞a k·∫øt n·ªëi socket
        if (messageText === '') {
            return;
        }
        if (!socket || !socket.connected) {
            try { if (socket) socket.connect(); } catch (e) {}
            alert('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi m√°y ch·ªß chat. Vui l√≤ng th·ª≠ l·∫°i sau.');
            return;
        }
        socket.emit('chat_message_send', {
            message: messageText,
            isImage: false
        });
        messageInput.value = '';
    }
    
    /**
     * T·∫£i ·∫£nh l√™n v√† g·ª≠i
     */
    async function handleUpload(event) {
        const file = event.target.files[0];
        if (!file || !socket) return;

        // Ch·∫∑n file qu√° l·ªõn t·ª´ ph√≠a client tr∆∞·ªõc khi g·ª≠i (tr√°nh l·ªói 413 Payload Too Large)
        if (file.size > MAX_IMAGE_SIZE_BYTES) {
            alert(`·∫¢nh qu√° l·ªõn. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n ${MAX_IMAGE_SIZE_MB}MB.`);
            imageInput.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('chatImage', file);
        try {
            // Kh√¥ng d√πng fetchAPI v√¨ n√≥ lu√¥n set Content-Type: application/json
            // G·ª≠i tr·ª±c ti·∫øp v·ªõi fetch + header Authorization n·∫øu c√≥ token
            const token = typeof window.getToken === 'function' ? window.getToken() : null;
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

            const response = await fetch('/api/chat/upload', {
                method: 'POST',
                headers,
                body: formData
            });

            if (response.status === 413) {
                // 413 Payload Too Large t·ª´ backend
                throw new Error(`·∫¢nh v∆∞·ª£t qu√° dung l∆∞·ª£ng cho ph√©p (>${MAX_IMAGE_SIZE_MB}MB).`);
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.');
            }

            if (data.imageUrl) {
                socket.emit('chat_message_send', {
                    message: data.imageUrl,
                    isImage: true
                });
            } else {
                throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh t·ª´ server.');
            }
        } catch (error) {
            alert(`L·ªói t·∫£i ·∫£nh: ${error.message}`);
        }
        imageInput.value = '';
    }

    /**
     * T·∫£i l·ªãch s·ª≠ chat t·ª´ server
     */
    async function loadChatHistory() {
        try {
            // [FIX] G·ªçi h√†m qua window.fetchAPI (t·ª´ main.js)
            const history = await window.fetchAPI('/api/chat/global-history?limit=200');
            chatMessagesEl.innerHTML = '';
            if (history.length === 0) {
                 addMessageToUI({
                    username: 'KingPredict',
                    message: 'üëë Ch√†o m·ª´ng ae! H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán.',
                    timestamp: new Date().toISOString(), isImage: false, isLeader: true
                }, false);
                return;
            }
            history.forEach(msg => {
                addMessageToUI(msg, false);
            });
            scrollToBottom(true);
        } catch (error) {
            chatMessagesEl.innerHTML = `<div class="text-center text-red-400">L·ªói t·∫£i l·ªãch s·ª≠ chat: ${error.message}</div>`;
        }
    }

    /**
     * K·∫øt n·ªëi Socket.IO v√† l·∫•y th√¥ng tin user
     */
    async function initializeChat() {
        // [FIX] Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa c√°c h√†m t·ª´ main.js
        if (typeof window.getToken !== 'function' || typeof window.fetchAPI !== 'function') {
            chatMessagesEl.innerHTML = '<div class="text-center text-red-400">L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c t·ªáp l·ªánh ch√≠nh (main.js). Vui l√≤ng l√†m m·ªõi trang (F5).</div>';
            return;
        }

        // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† l·∫•y th√¥ng tin
        // [FIX] G·ªçi h√†m qua window.getToken
        const token = window.getToken();
        if (!token) {
            chatMessagesEl.innerHTML = '<div class="text-center text-yellow-400">Vui l√≤ng <a href="login" class="underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ tham gia chat.</div>';
            messageInput.disabled = true;
            sendBtn.disabled = true;
            uploadBtn.disabled = true;
            return;
        }
        
        try {
            // [FIX] Gi·ªù h√†m jwt_decode (ƒë·ªãnh nghƒ©a ·ªü tr√™n) ƒë√£ t·ªìn t·∫°i
            const payload = jwt_decode(token);
            if (!payload) {
                throw new Error("Token kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã h·ªèng.");
            }
            MY_USER_ID = payload.userId;
            
            // [FIX] G·ªçi h√†m qua window.fetchAPI
            const profile = await window.fetchAPI('/user/profile');
            MY_USERNAME = profile.username;
            const savedAvatar = localStorage.getItem('userAvatarUrl');
            MY_AVATAR_URL = savedAvatar || profile.avatar || null;
        } catch (e) {
            console.error("L·ªói x√°c th·ª±c ho·∫∑c t·∫£i profile:", e);
            chatMessagesEl.innerHTML = `<div class="text-center text-red-400">L·ªói x√°c th·ª±c. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i. ${e.message}</div>`;
            return;
        }
        
        // Th√™m th√¥ng b√°o ƒëang t·∫£i...
        chatMessagesEl.innerHTML = '<div class="text-center text-gray-500 text-sm">ƒêang t·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán...</div>';

        // 2. T·∫£i l·ªãch s·ª≠ chat
        await loadChatHistory();

        // 3. K·∫øt n·ªëi Socket (h√†m io() l√† global t·ª´ CDN, n√™n ok)
        socket = io(window.location.origin, {
            query: { user_id: MY_USER_ID }
        });

        // 4. L·∫Øng nghe c√°c s·ª± ki·ªán t·ª´ server
        socket.on('connect', () => {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            uploadBtn.disabled = false;
        });
        socket.on('connect_error', () => {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            uploadBtn.disabled = true;
        });
        
        // N·∫øu k·∫øt n·ªëi socket th·∫•t b·∫°i (server t·∫Øt, sai c·ªïng, ...), hi·ªÉn th·ªã th√¥ng b√°o r√µ r√†ng
        socket.io.on('error', (err) => {
            console.error('L·ªói k·∫øt n·ªëi Socket.IO:', err);
            chatMessagesEl.innerHTML = '<div class="text-center text-red-400">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi m√°y ch·ªß chat. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá admin.</div>';
            messageInput.disabled = true;
            sendBtn.disabled = true;
            uploadBtn.disabled = true;
        });
        socket.io.on('reconnect_error', () => {
            chatMessagesEl.innerHTML = '<div class="text-center text-red-400">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi m√°y ch·ªß chat. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá admin.</div>';
            messageInput.disabled = true;
            sendBtn.disabled = true;
            uploadBtn.disabled = true;
        });

        socket.on('chat_user_count', (count) => {
            userCountEl.textContent = count;
        });
        socket.on('chat_message_broadcast', (msg) => {
            addMessageToUI(msg, true);
        });
        socket.on('chat_message_ack', () => {});
        socket.on('chat_error', (errorMessage) => {
            alert(errorMessage);
        });

        // 5. G√°n s·ª± ki·ªán cho c√°c n√∫t
        sendBtn.addEventListener('click', handleSend);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        uploadBtn.addEventListener('click', () => { imageInput.click(); });
        imageInput.addEventListener('change', handleUpload);
    }
    
    // === KH·ªûI CH·∫†Y ===
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeChat);
    } else {
        initializeChat();
    }
</script>
</body>
</html>
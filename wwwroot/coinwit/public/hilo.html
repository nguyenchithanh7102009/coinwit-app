<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hi-Lo Royale - CoinWit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* === GIỮ NGUYÊN GIAO DIỆN GỐC (TỪ MINES.HTML) === */
        :root {
            --yellow-accent: #facc15; /* yellow-400 */
            --dark-bg: #0a0a0e;
            --card-bg: #1a1b20;
            --border-color: #2b2d35; 
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0; 
            
            --yellow-primary: var(--yellow-accent); 
            --yellow-hover: #eab308; 
            --vip-gem: #ffffff; 
            --platinum: #f0f0f0; 
            --red-light: #ef4444; /* Dùng cho nút LO và suit Đỏ */
            --green-light: #22c55e; /* Dùng cho nút HI */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at center, #1a1b20 0%, var(--dark-bg) 70%);
            color: var(--text-primary);
            /* [SỬA] Bỏ overflow: hidden; để cho phép cuộn */
            overflow-x: hidden; /* Chỉ ẩn cuộn ngang */
        }
        
        .glass-panel {
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header-sticky {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        /* Các nút (Vàng, Xám, Platinum) giữ nguyên từ mines.html */
        .btn-yellow-primary {
            background: linear-gradient(145deg, #fde047, #facc15);
            border: 1px solid #eab308;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            color: #000;
            font-weight: 700;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.3);
        }
        .btn-yellow-primary:hover:not(:disabled) {
            background: linear-gradient(145deg, #fef08a, #fde047);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.5);
        }
        .btn-yellow-primary:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: scale(1);
            border: 1px solid var(--border-color);
            text-shadow: none;
        }

        .btn-dark-toggle {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .btn-dark-toggle:hover:not(:disabled) {
            background-color: #333;
            border-color: var(--text-secondary);
        }

        .btn-platinum {
            background: linear-gradient(145deg, #ffffff, #e0e0e0);
            border: 1px solid #f0f0f0;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            color: #000;
            font-weight: 700;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .btn-platinum:hover:not(:disabled) {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
        }
        .btn-platinum:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: scale(1);
            border: 1px solid var(--border-color);
            text-shadow: none;
        }

        .bet-input {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--yellow-primary);
            font-weight: 700;
            transition: all 0.2s;
        }
        .bet-input:focus {
            border-color: var(--yellow-primary);
            outline: none;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
        }
        
        /* === [THAY THẾ] CSS CHO GAME HI-LO === */
        
        /* Bàn chơi (Nơi đặt lá bài) */
        .hilo-game-board {
            /* Thêm một lớp nền "spotlight" nhẹ */
            background: radial-gradient(ellipse at center, #2a2b30 0%, var(--card-bg) 70%);
        }

        /* Thẻ bài */
        .card-flipper {
            perspective: 1000px;
            display: block;
        }
        .card-inner {
            position: relative;
            width: 100%;
            /* Tỷ lệ lá bài chuẩn (2.5 x 3.5 inch) */
            aspect-ratio: 2.5 / 3.5;
            max-width: 250px; /* Giới hạn kích thước tối đa */
            margin: 0 auto;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        /* Lật lá bài */
        .card-inner.flipped {
            transform: rotateY(180deg);
        }
        
        /* Mặt trước (card-front) và mặt sau (card-back) */
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* [SỬA] Mặt trước (Giá trị lá bài) - MẠ VÀNG */
        .card-front {
            /* Nâng cấp: Nền vàng kem sang trọng */
            background: linear-gradient(145deg, #fefce8, #fffbeb);
            border: 2px solid var(--yellow-primary); /* Viền vàng */
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.4); /* Thêm bóng mờ vàng */
            
            /* [SỬA] Đổi màu chữ/số mặc định thành màu vàng */
            color: var(--yellow-hover); /* #eab308 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            
            transform: rotateY(180deg);
            
            /* Sắp xếp nội dung lá bài */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0.5rem; /* 8px */
        }
        
        .card-value-small {
            font-size: 1.5rem; /* 24px */
            font-weight: 800;
            line-height: 1;
        }
        .card-suit-small {
            font-size: 1.25rem; /* 20px */
            line-height: 1;
        }
        .card-suit-center {
            font-size: 4rem; /* 64px */
            line-height: 1;
        }
        
        /* [SỬA] Màu cho các chất (Suit) - TẤT CẢ MÀU VÀNG */
        .suit-red { color: var(--yellow-hover); }
        .suit-black { color: var(--yellow-hover); }

        /* [SỬA] Mặt sau (Logo game) - THÊM VIỀN VÀNG */
        .card-back {
            /* Tái sử dụng nền của .game-tile từ Mines */
            background: radial-gradient(circle, #383a42 0%, #2b2d35 80%);
            
            /* Nâng cấp: Viền vàng và bóng mờ */
            border: 2px solid var(--yellow-primary);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.4);

            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-back i {
            /* Icon kim cương vàng lấp lánh */
            font-size: 4rem;
            color: var(--yellow-primary);
            text-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
            animation: pulse-gem 2s infinite ease-in-out;
        }

        /* Keyframe cho icon mặt sau (lấy từ Mines) */
        @keyframes pulse-gem {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        /* Các lá bài đã lật (Lịch sử) */
        #hilo-history-row {
            min-height: 4.5rem; /* 72px */
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            /* [SỬA] Cho phép cuộn ngang và ẩn thanh cuộn */
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #hilo-history-row::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        .skipped-card {
            width: 2.5rem; /* 40px */
            height: 3.5rem; /* 56px */
            display: inline-flex; /* [SỬA] Đổi sang inline-flex */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            color: var(--yellow-hover); /* [SỬA] Đổi màu chữ/số lá bài lịch sử */
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-right: 0.5rem; /* [THÊM] Khoảng cách */
        }
        .skipped-card i {
            font-size: 0.75rem;
        }

        /* Nút Hi-Lo (MỚI) */
        .btn-hilo {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem 0.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.125rem; /* 18px */
            color: var(--text-primary);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-hilo:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            border-color: var(--border-color);
        }
        .btn-hilo:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .btn-hilo .multiplier-tag {
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: var(--text-primary);
            background-color: rgba(0,0,0,0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 99px;
            margin-top: 0.5rem;
        }
        
        /* [SỬA] Nút HI (Vàng sang trọng) */
        .btn-hilo-hi {
            background: linear-gradient(145deg, #fde047, #facc15);
            border-color: #eab308;
            color: #000; /* Đổi chữ thành đen để dễ đọc */
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
        }
        .btn-hilo-hi:not(:disabled):hover {
            background: linear-gradient(145deg, #fef08a, #fde047);
        }
        .btn-hilo-hi .multiplier-tag {
            color: #000; /* Đổi màu tag */
            background-color: rgba(0,0,0,0.1);
        }
        
        /* [SỬA] Nút LO (Xám/Platinum sang trọng) */
        .btn-hilo-lo {
            background: linear-gradient(145deg, #ffffff, #e0e0e0);
            border-color: #f0f0f0;
            color: #000; /* Đổi chữ thành đen để dễ đọc */
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
        }
        .btn-hilo-lo:not(:disabled):hover {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
        }
        .btn-hilo-lo .multiplier-tag {
            color: #000; /* Đổi màu tag */
            background-color: rgba(0,0,0,0.1);
        }
        
        /* === [SỬA] CSS CHO MÀN HÌNH CHỜ (IDLE) === */
        .idle-card-container {
            position: relative;
            height: 120px; /* Chiều cao cố định cho 2 lá bài */
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .idle-card {
            /* Tái sử dụng nền của card-back */
            background: radial-gradient(circle, #383a42 0%, #2b2d35 80%);
            
            /* [SỬA] Nâng cấp: Viền vàng và bóng mờ (giống .card-back) */
            border: 2px solid var(--yellow-primary);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.4);
            
            border-radius: 0.5rem; /* Bo góc nhỏ hơn */
            
            /* Kích thước cố định (tỷ lệ ~2.5:3.5) */
            width: 80px;
            height: 112px;
            
            /* Cho phép chồng chéo */
            position: absolute;
            
            /* Icon bên trong */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* [THÊM] Icon cho 2 lá bài idle (Spade & Heart) */
        .idle-card-1 i {
            font-size: 2.5rem;
            color: var(--vip-gem); /* Spade (trắng) */
            text-shadow: 0 0 8px var(--vip-gem);
            animation: pulse-gem 2s infinite ease-in-out;
        }
        .idle-card-2 i {
            font-size: 2.5rem;
            color: var(--red-light); /* Heart (đỏ) */
            text-shadow: 0 0 8px var(--red-light);
            animation: pulse-gem 2s infinite 0.2s; /* So le animation */
        }
        
        /* [SỬA] Xoay 2 lá bài (giữ nguyên) */
        .idle-card-1 {
            transform: rotate(-15deg) translateX(-20px);
            animation-delay: 0.2s; /* Cho 2 animation chạy so le */
        }
        .idle-card-2 {
            transform: rotate(10deg) translateX(20px);
        }
        /* === HẾT CSS MÀN HÌNH CHỜ === */


        /* === CSS CÒN LẠI (GIỮ NGUYÊN TỪ MINES) === */

        /* Modals */
        .modal-overlay {
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .modal-card {
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            animation: modalPopIn 0.3s ease;
        }
        
        /* Modal Lịch Sử */
        .modal-overlay-history {
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .loader-history { 
            border: 4px solid #f3f3f340; 
            border-top: 4px solid var(--yellow-primary); 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ẩn thanh cuộn cho modal lịch sử */
        #history-panel-container::-webkit-scrollbar { display: none; }
        #history-panel-container { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalPopIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .screen-shake { animation: screenShake 0.4s ease; }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        /* Confetti (Giữ nguyên) */
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        .confetti-piece { position: absolute; width: 8px; height: 16px; background-color: var(--yellow-primary); opacity: 0.8; animation: confettiFall 3s ease-out forwards; }
        .confetti-piece:nth-child(2) { background-color: var(--vip-gem); animation-delay: 0.1s; } 
        .confetti-piece:nth-child(3) { background-color: #3b82f6; animation-delay: 0.2s; }
        /* ... (giữ nguyên các confetti-piece khác) ... */
        @keyframes confettiFall {
            from { top: -20px; transform: rotate(0deg) scale(1); }
            to { top: 100%; transform: rotate(720deg) scale(0.5); opacity: 0; }
        }
        
        /* Layout (Giữ nguyên) */
        .control-panel-desktop {
            position: fixed; 
            top: 2.5rem; 
            right: 0;
            bottom: 0;
            width: 24rem; /* 384px (lg:w-96) */
            padding: 1rem;
            overflow-y: auto; 
            z-index: 20; 
        }
        @media (max-width: 1023px) { .control-panel-desktop { display: none; } }
        @media (min-width: 1024px) { .main-game-area { margin-right: 24rem; } }

        /* Marquee (Giữ nguyên) */
        .ticker-wrap { white-space: nowrap; will-change: transform; }
        .ticker-item { flex-shrink: 0; display: inline-flex; align-items: center; padding: 0 1.5rem; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* [SỬA] XÓA BỎ PHẦN CSS THANH CUỘN TÙY CHỈNH CHO #main-content */
        /* (Đoạn mã CSS trước đó đã bị xóa) */

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="notification-ticker" class="absolute top-0 left-0 w-full h-10 z-30 hidden lg:flex items-center overflow-hidden" style="background-color: var(--dark-bg); border-bottom: 1px solid var(--border-color);">
        <div id="ticker-wrap-dynamic" class="ticker-wrap flex items-center">
            </div>
    </div>

    <div id="user-info-mobile" class="lg:hidden absolute top-0 left-0 w-full z-30 p-2 glass-panel transition-all duration-300" style="border-radius: 0; border-left: 0; border-right: 0;">
        <div class="flex flex-col sm:flex-row items-center justify-between w-full">
            <div class="flex flex-col sm:flex-row sm:items-center gap-x-3 gap-y-1 min-w-0 w-full sm:w-auto">
                <span id="user-vitals-mobile" class="text-xs sm:text-sm text-white font-semibold truncate">Xin chào, ...</span>
                <div class="flex items-baseline gap-1.5">
                    <span class="text-xs text-gray-400">Số dư:</span>
                    <span id="balance-mobile" class="font-bold text-sm sm:text-base truncate" style="color: var(--yellow-accent);">0.00 ₫</span>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                <a href="http://coinwit.net/index.html" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-home mr-1"></i>
                    <span>TRANG CHỦ</span>
                </a>
                <button id="my-history-btn-mobile" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-history mr-1"></i>
                    <span>LỊCH SỬ CƯỢC</span>
                </button>
                <button id="currency-toggle-btn-mobile" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-exchange-alt mr-1"></i>
                    <span>Đổi (USDT)</span>
                </button>
                <a href="deposit" class="btn-yellow-primary py-1 px-2 text-xs sm:text-sm block text-center w-1/4 sm:w-auto">
                    <i class="fas fa-wallet mr-1"></i>
                    <span>NẠP TIỀN</span>
                </a>
            </div>
        </div>
    </div>

    <main id="main-content" class="flex-grow flex flex-col lg:flex-row">
        
        <div class="main-game-area flex-grow flex justify-center items-center p-4 lg:p-8">
            <div class="w-full max-w-sm"> <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Hệ số Hiện tại</p>
                        <p id="next-multiplier" class="text-lg font-bold text-white">--</p>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Thắng tiềm năng</p>
                        <p id="potential-payout" class="text-lg font-bold" style="color: var(--yellow-accent);">0.00</p>
                    </div>
                </div>

                <div id="hilo-game-board" class="w-full mx-auto p-4 glass-panel hilo-game-board" style="display: none;"> <div class="card-flipper mb-4">
                        <div id="card-inner" class="card-inner">
                            <div class="card-front">
                                <div class="flex justify-between items-center">
                                    <div class="text-left">
                                        <span id="card-value-top" class="card-value-small">A</span>
                                        <i id="card-suit-top" class="fas fa-spade card-suit-small"></i>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <i id="card-suit-center" class="fas fa-spade card-suit-center"></i>
                                </div>
                                <div class="flex justify-between items-center transform rotate-180">
                                     <div class="text-left">
                                        <span id="card-value-bottom" class="card-value-small">A</span>
                                        <i id="card-suit-bottom" class="fas fa-spade card-suit-small"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back">
                                <i class="fa-solid fa-gem"></i>
                            </div>
                        </div>
                    </div>
    
                    <div id="hilo-history-row" class="flex items-center mb-4">
                        </div>
    
                    <div class="hidden lg:grid grid-cols-2 gap-4">
                        <button id="guess-lo-btn-desktop" class="btn-hilo btn-hilo-lo" disabled>
                            <i class="fas fa-arrow-down"></i>
                            <span>THẤP HƠN</span>
                            <span id="multiplier-lo-desktop" class="multiplier-tag">--x</span>
                        </button>
                        <button id="guess-hi-btn-desktop" class="btn-hilo btn-hilo-hi" disabled>
                            <i class="fas fa-arrow-up"></i>
                            <span>CAO HƠN</span>
                            <span id="multiplier-hi-desktop" class="multiplier-tag">--x</span>
                        </button>
                    </div>
                </div>

                <div id="hilo-idle-message" class="text-center p-8 glass-panel max-w-sm mx-auto">
                    
                    <div class="idle-card-container">
                        <div class="idle-card idle-card-1">
                            <i class="fa-solid fa-spade"></i> </div>
                        <div class="idle-card idle-card-2">
                            <i class="fa-solid fa-heart"></i> </div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">HI-LO ROYALE</h2>
                     <p class="text-gray-300">Đặt cược và dự đoán lá bài tiếp theo sẽ cao hơn hay thấp hơn.</p>
                </div>
                </div>
        </div>

        <div class="hidden lg:flex lg:flex-col glass-panel space-y-4 control-panel-desktop">
            
            <div class="glass-panel p-4 space-y-4">
                <p id="info-username-desktop" class="text-sm font-medium text-gray-300 truncate">Xin chào, ...</p>
                <p class="text-xl">
                    <span class="text-gray-300">Số dư: </span>
                    <span id="info-balance-desktop-amount" class="font-bold" style="color: var(--yellow-accent);">0.00 ₫</span>
                </p>
                <div class="flex flex-col gap-2">
                    <a href="http://coinwit.net/index.html" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fas fa-home mr-1"></i> TRANG CHỦ
                    </a>
                    <button id="my-history-btn-desktop" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> LỊCH SỬ CƯỢC
                    </button>
                    <button id="currency-toggle-btn-desktop" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fa-solid fa-right-left mr-1"></i> <span>ĐỔI (USDT)</span>
                    </button>
                    <a href="deposit" class="block text-center py-3 rounded-lg btn-yellow-primary text-sm">
                        <i class="fa-solid fa-wallet mr-1"></i> NẠP TIỀN
                    </a>
                </div>
            </div>
            
            <div class="glass-panel p-4 space-y-4 flex-grow flex flex-col">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Hệ số Hiện tại</p>
                        <p id="next-multiplier-desktop" class="text-lg font-bold text-white">--</p>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Thắng tiềm năng</p>
                        <p id="potential-payout-desktop" class="text-lg font-bold" style="color: var(--yellow-accent);">0.00</p>
                    </div>
                </div>

                <div>
                    <label for="bet-amount-desktop" class="text-sm font-medium text-gray-300 mb-2 block cursor-pointer">Số tiền</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--yellow-accent);">
                            <i class="fa-solid fa-dollar-sign"></i>
                        </span>
                        <input id="bet-amount-desktop" type="number" value="1" class="w-full bet-input rounded-lg py-2.5 pl-9 pr-16 font-bold">
                        <span id="bet-currency-label-desktop" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-semibold" style="color: var(--text-secondary);">
                            USDT
                        </span>
                    </div>
                    </div>
                
                <button id="action-button-desktop" class="w-full py-3.5 rounded-lg text-lg btn-yellow-primary mt-auto">
                    Bắt đầu
                </button>
            </div>
        </div>
    </main>

    <footer class="lg:hidden w-full glass-panel p-4 flex-shrink-0" style="border-radius: 0.5rem 0.5rem 0 0; border-bottom: 0;">
        <div class="w-full max-w-md mx-auto">
            
            <div id="hilo-buttons-mobile-container" class="grid grid-cols-2 gap-4 mb-3" style="display: none;">
                <button id="guess-lo-btn" class="btn-hilo btn-hilo-lo" disabled>
                    <i class="fas fa-arrow-down"></i>
                    <span>THẤP HƠN</span>
                    <span id="multiplier-lo" class="multiplier-tag">--x</span>
                </button>
                <button id="guess-hi-btn" class="btn-hilo btn-hilo-hi" disabled>
                    <i class="fas fa-arrow-up"></i>
                    <span>CAO HƠN</span>
                    <span id="multiplier-hi" class="multiplier-tag">--x</span>
                </button>
            </div>

            <div id="hilo-bet-mobile-container" class="mb-3" style="display: block;">
                <label for="bet-amount-mobile" class="text-xs text-gray-400 mb-1 block cursor-pointer">Số tiền</label>
                 <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--yellow-accent);">
                        <i class="fa-solid fa-dollar-sign"></i>
                    </span>
                    <input id="bet-amount-mobile" type="number" value="1" class="w-full bet-input rounded-lg py-2.5 pl-9 pr-16 text-white font-bold">
                    <span id="bet-currency-label-mobile" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-semibold" style="color: var(--text-secondary);">
                        USDT
                    </span>
                </div>
            </div>
            
            <button id="action-button-mobile" class="w-full py-3.5 rounded-lg text-lg btn-yellow-primary">
                Bắt đầu
            </button>
        </div>
    </footer>
    
    <div id="failure-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center">
            <i class="fa-solid fa-xmark-circle text-5xl text-red-light mb-4"></i>
            <h2 id="failure-modal-title" class="text-2xl font-bold text-white mb-2">Thua rồi!</h2>
            <p id="failure-modal-message" class="text-gray-300 mb-6">Dự đoán sai. Chúc may mắn lần sau.</p>
            <button id="failure-modal-close" class="w-full py-2.5 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors">
                OK
            </button>
        </div>
    </div>
    
    <div id="success-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="confetti-container">
            <div class="confetti-piece" style="left: 10%; animation-delay: 0s;"></div>
            <div class="confetti-piece" style="left: 20%; animation-delay: 0.1s;"></div>
            <div class="confetti-piece" style="left: 30%; animation-delay: 0.2s;"></div>
            <div class="confetti-piece" style="left: 40%; animation-delay: 0.3s;"></div>
            <div class="confetti-piece" style="left: 50%; animation-delay: 0.4s;"></div>
            <div class="confetti-piece" style="left: 60%; animation-delay: 0.5s;"></div>
            <div class="confetti-piece" style="left: 70%; animation-delay: 0.6s;"></div>
            <div class="confetti-piece" style="left: 80%; animation-delay: 0.7s;"></div>
            <div class="confetti-piece" style="left: 90%; animation-delay: 0.8s;"></div>
            <div class="confetti-piece" style="left: 5%; animation-delay: 0.9s;"></div>
            <div class="confetti-piece" style="left: 25%; animation-delay: 1.0s;"></div>
            <div class="confetti-piece" style="left: 75%; animation-delay: 1.1s;"></div>
        </div>
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center relative">
            <i class="fa-solid fa-circle-check text-5xl text-white mb-4"></i>
            <h2 class="text-2xl font-bold text-white mb-2">Xuất sắc!</h2>
            <p id="success-modal-message" class="text-gray-300 mb-6">Bạn đã rút tiền thành công!</p>
            <button id="success-modal-close" class="w-full py-2.5 rounded-lg font-semibold btn-yellow-primary">
                Tuyệt vời
            </button>
        </div>
    </div>
    
    <div id="warning-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center">
            <i class="fa-solid fa-triangle-exclamation text-5xl text-yellow-primary mb-4"></i>
            <h2 id="warning-modal-title" class="text-2xl font-bold text-white mb-2">Lỗi</h2>
             <p id="warning-modal-message" class="text-gray-300 mb-6">Bạn phải lật ít nhất 1 kim cương.</p>
            <button id="warning-modal-close" class="w-full py-2.5 rounded-lg font-semibold btn-yellow-primary">
                Đã hiểu
            </button>
        </div>
    </div>
    
    <div id="my-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay-history">
        <div class="absolute inset-0"></div>
        <div class="relative w-full max-w-lg rounded-lg shadow-xl flex flex-col modal-card" style="max-height: 80vh;">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border-color)]">
                <h3 class="text-lg font-bold text-white">Lịch sử cược của tôi (Hi-Lo)</h3>
                <button id="my-history-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="history-panel-container" class="overflow-y-auto p-4 space-y-2">
                <div id="history-loading" class="text-center text-gray-400">
                    <div class="loader-history inline-block"></div>
                    <span class="ml-2">Đang tải lịch sử...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="main.js"></script> <script>
        // Trạng thái game
        let uiState = 'IDLE';
        let currentGame = null;
        let userBalance = 0;
        
        const MIN_BET_USDT = 0.10;
        // [THÊM MỚI] Sao chép hằng số từ server.js
        const HOUSE_EDGE = 0.05;

        // --- [SỬA] Elements ---
        // [SỬA] Khai báo (let), CHƯA gán
        let nextMultiplierEl, potentialPayoutEl, nextMultiplierDesktopEl, potentialPayoutDesktopEl,
            balanceHeaderEl, userInfoMobileEl, mainContentEl, infoUsernameMobile, infoBalanceMobile,
            infoUsernameDesktop, infoBalanceDesktop, betAmountMobile, betAmountDesktop,
            actionButtonMobile, actionButtonDesktop, currencyToggleBtnMobile, currencyToggleBtnDesktop,
            failureModal, failureModalTitle, failureModalMessage, failureModalClose,
            successModal, successModalMessage, successModalClose, warningModal, warningModalTitle,
            warningModalMessage, warningModalClose, myHistoryBtnMobile, myHistoryBtnDesktop,
            myHistoryModal, myHistoryCloseBtn, historyPanelContainer, historyLoading,
            hiloGameBoard, hiloIdleMessage, cardInner, hiloHistoryRow, guessLoBtn, guessHiBtn,
            multiplierLo, multiplierHi, cardValueTop, cardSuitTop, cardSuitCenter,
            cardValueBottom, cardSuitBottom,
            
            // [THÊM MỚI]
            hiloBetMobileContainer, hiloButtonsMobileContainer,
            guessLoBtnDesktop, guessHiBtnDesktop,
            multiplierLoDesktop, multiplierHiDesktop;


        // --- [SỬA LỚN] Thay thế 'DOMContentLoaded' bằng IIFE ---
        // (Vì script đã ở cuối <body>, DOM đã sẵn sàng)
        (async () => {
            
            // --- Gán giá trị cho Elements tại đây ---
            nextMultiplierEl = document.getElementById('next-multiplier');
            potentialPayoutEl = document.getElementById('potential-payout');
            nextMultiplierDesktopEl = document.getElementById('next-multiplier-desktop');
            potentialPayoutDesktopEl = document.getElementById('potential-payout-desktop');
            balanceHeaderEl = document.getElementById('user-balance-header');
            userInfoMobileEl = document.getElementById('user-info-mobile'); 
            mainContentEl = document.getElementById('main-content'); 
            infoUsernameMobile = document.getElementById('user-vitals-mobile');
            infoBalanceMobile = document.getElementById('balance-mobile');
            infoUsernameDesktop = document.getElementById('info-username-desktop');
            infoBalanceDesktop = document.getElementById('info-balance-desktop-amount'); 
            betAmountMobile = document.getElementById('bet-amount-mobile');
            betAmountDesktop = document.getElementById('bet-amount-desktop');
            actionButtonMobile = document.getElementById('action-button-mobile');
            actionButtonDesktop = document.getElementById('action-button-desktop');
            currencyToggleBtnMobile = document.getElementById('currency-toggle-btn-mobile');
            currencyToggleBtnDesktop = document.getElementById('currency-toggle-btn-desktop');
            failureModal = document.getElementById('failure-modal');
            failureModalTitle = document.getElementById('failure-modal-title');
            failureModalMessage = document.getElementById('failure-modal-message');
            failureModalClose = document.getElementById('failure-modal-close');
            successModal = document.getElementById('success-modal');
            successModalMessage = document.getElementById('success-modal-message');
            successModalClose = document.getElementById('success-modal-close');
            warningModal = document.getElementById('warning-modal');
            warningModalTitle = document.getElementById('warning-modal-title');
            warningModalMessage = document.getElementById('warning-modal-message');
            warningModalClose = document.getElementById('warning-modal-close');
            myHistoryBtnMobile = document.getElementById('my-history-btn-mobile');
            myHistoryBtnDesktop = document.getElementById('my-history-btn-desktop');
            myHistoryModal = document.getElementById('my-history-modal');
            myHistoryCloseBtn = document.getElementById('my-history-close-btn');
            historyPanelContainer = document.getElementById('history-panel-container');
            historyLoading = document.getElementById('history-loading');
            hiloGameBoard = document.getElementById('hilo-game-board');
            hiloIdleMessage = document.getElementById('hilo-idle-message');
            cardInner = document.getElementById('card-inner');
            hiloHistoryRow = document.getElementById('hilo-history-row');
            guessLoBtn = document.getElementById('guess-lo-btn');
            guessHiBtn = document.getElementById('guess-hi-btn');
            multiplierLo = document.getElementById('multiplier-lo');
            multiplierHi = document.getElementById('multiplier-hi');
            cardValueTop = document.getElementById('card-value-top');
            cardSuitTop = document.getElementById('card-suit-top');
            cardSuitCenter = document.getElementById('card-suit-center');
            cardValueBottom = document.getElementById('card-value-bottom');
            cardSuitBottom = document.getElementById('card-suit-bottom');
            
            // [THÊM MỚI]
            hiloBetMobileContainer = document.getElementById('hilo-bet-mobile-container');
            hiloButtonsMobileContainer = document.getElementById('hilo-buttons-mobile-container');
            guessLoBtnDesktop = document.getElementById('guess-lo-btn-desktop');
            guessHiBtnDesktop = document.getElementById('guess-hi-btn-desktop');
            multiplierLoDesktop = document.getElementById('multiplier-lo-desktop');
            multiplierHiDesktop = document.getElementById('multiplier-hi-desktop');
            
            // --- HẾT GÁN ELEMENTS ---

            // Kiểm tra và khởi tạo các hàm toàn cục (formatCurrency, initCurrency, checkLogin, fetchAPI)
            if (typeof initCurrency === 'undefined' || typeof checkLogin === 'undefined') {
                // Fallback nếu không có main.js
                window.globalCurrency = 'USDT';
                window.globalExchangeRate = 25000;
                window.formatCurrency = (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
                window.checkLogin = () => true;
            } else {
                await initCurrency(); 
                if (!checkLogin(true)) return;
            }

            try {
                // Giả định fetchAPI đã được định nghĩa trong main.js
                const data = typeof fetchAPI !== 'undefined' ? await fetchAPI('/user/profile') : { username: 'Khách', balance: 1000.00 };
                userBalance = data.balance;
                if(infoUsernameMobile) infoUsernameMobile.textContent = `Xin chào, ${data.username}`; 
                if(infoUsernameDesktop) infoUsernameDesktop.textContent = `Xin chào, ${data.username}`;
                updateBalanceDisplay(); 
                updateCurrencyToggleText(); 
                updateBetCurrencyLabel(); 
            } catch (error) {
            }
            
            setupEventListeners(); // Gán sự kiện
            
            // [SỬA] Kiểm tra ván game Hi-Lo đang hoạt động
            await checkActiveHiloGame(); 
            
            if (uiState !== 'BETTING') {
                updateUIState('IDLE');
            }

            setBetAmount(1.00); 
            
            // [THÊM] Khởi động ticker
            setupDynamicTicker();
        })(); // <-- Tự động chạy hàm async
        // --- KẾT THÚC KHỐI KHỞI TẠO IIFE ---


        // [SỬA LỖI LOGIC] Hàm tính toán Multiplier (GIỜ ĐÃ TỰ TÍNH VALUE)
        function calculateHiloMultiplier(currentValue, deck) {
            // currentValue bây giờ là giá trị SỐ (ví dụ: 14 cho 'A')
            
            if (!deck || deck.length === 0) {
                return { hiMultiplier: 1.0, loMultiplier: 1.0, highCount: 0, lowCount: 0 };
            }

            let lowCount = 0;
            let highCount = 0;
            let tieCount = 0;

            deck.forEach(card => {
                // [SỬA LỖI LOGIC] Phớt lờ card.value, tự tính toán value từ card.rank
                const val = RANK_VALUES[card.rank] || 0; // Lấy value từ map
                
                if (val < currentValue) lowCount++;
                else if (val > currentValue) highCount++;
                else tieCount++;
            });
            
            const totalRemaining = deck.length; // Tổng số lá còn lại

            // Tính toán an toàn, tránh chia cho 0
            const hiMultiplier = (highCount > 0) ? (totalRemaining / highCount) * (1 - HOUSE_EDGE) : 1.0;
            const loMultiplier = (lowCount > 0) ? (totalRemaining / lowCount) * (1 - HOUSE_EDGE) : 1.0;
            
            return {
                hiMultiplier: parseFloat(hiMultiplier.toFixed(2)),
                loMultiplier: parseFloat(loMultiplier.toFixed(2)),
                highCount,
                lowCount
            };
        }

        // [SỬA LỖI LOGIC] Hàm kiểm tra và khôi phục game
        async function checkActiveHiloGame() {
            if (typeof fetchAPI === 'undefined') return;

            try {
                // [SỬA] Đổi API endpoint
                const data = await fetchAPI('/game/hilo/check-active');
                
                if (data.active) {
                    
                    // Khôi phục đối tượng game (Giống server.js)
                    currentGame = {
                        sessionId: data.sessionId,
                        betAmount: data.betAmount,
                        currentMultiplier: data.currentMultiplier,
                        currentCard: data.currentCard,
                        deck: data.deck, // [SỬA] Server gửi 'deck'
                        history: data.history || []
                    };
                    
                    // Khôi phục lá bài hiện tại
                    updateCardDisplay(currentGame.currentCard);
                    cardInner.classList.add('flipped'); // Hiển thị ngay
                    
                    // Khôi phục lịch sử
                    hiloHistoryRow.innerHTML = '';
                    currentGame.history.forEach(card => addCardToHistory(card));
                    
                    // [SỬA LỖI LOGIC] Tự tính toán multipliers DỰA TRÊN RANK
                    const currentCardValue = RANK_VALUES[currentGame.currentCard.rank] || 0;
                    const multipliers = calculateHiloMultiplier(currentCardValue, currentGame.deck);
                    updateMultipliers(multipliers);

                    // Cập nhật trạng thái
                    updateUIState('BETTING');
                }
            } catch (error) {
            }
        }

        // --- Các hàm UI (Giữ nguyên) ---
        function updateBalanceDisplay() {
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            const formattedBalance = formatter(userBalance);
            if(balanceHeaderEl) balanceHeaderEl.textContent = formattedBalance; 
            if(infoBalanceMobile) infoBalanceMobile.textContent = formattedBalance; 
            if(infoBalanceDesktop) infoBalanceDesktop.textContent = formattedBalance;
        }

        function updateCurrencyToggleText() {
            const currentCurrency = window.globalCurrency || 'USDT';
            const text = (currentCurrency === 'USDT' ? 'Đổi (VND)' : 'Đổi (USDT)');
            if (currencyToggleBtnMobile) currencyToggleBtnMobile.querySelector('span').textContent = text; 
            if (currencyToggleBtnDesktop) currencyToggleBtnDesktop.querySelector('span').textContent = text;
        }

        function updateBetCurrencyLabel() {
            const currentCurrency = window.globalCurrency || 'USDT';
            const labelDesktop = document.getElementById('bet-currency-label-desktop');
            const labelMobile = document.getElementById('bet-currency-label-mobile');
            const currencyText = (currentCurrency === 'VND') ? 'vnđ' : 'USDT';
            if (labelDesktop) labelDesktop.textContent = currencyText;
            if (labelMobile) labelMobile.textContent = currencyText;
        }

        async function toggleCurrency() {
            if (typeof initCurrency === 'undefined') {
                return;
            }
            const currentCurrency = window.globalCurrency || 'USDT';
            const newCurrency = (currentCurrency === 'USDT') ? 'VND' : 'USDT';
            localStorage.setItem('selectedCurrency', newCurrency);
            await initCurrency(); 
            updateBalanceDisplay(); 
            updateCurrencyToggleText(); 
            updateBetCurrencyLabel(); 
            const currentBetUSDT = parseFloat(betAmountDesktop.dataset.amountUsdt || betAmountMobile.dataset.amountUsdt || 1);
            setBetAmount(currentBetUSDT);
        }

        // --- Các hàm cược (Giữ nguyên) ---
        function setBetAmount(amountUSDT) {
            const numAmount = parseFloat(amountUSDT);
            if (isNaN(numAmount) || typeof formatCurrency === 'undefined') return;

            // [SỬA] Thêm null check (Phòng hờ lỗi)
            if (!betAmountMobile || !betAmountDesktop) {
                return;
            }
            
            betAmountMobile.dataset.amountUsdt = numAmount.toFixed(4);
            betAmountDesktop.dataset.amountUsdt = numAmount.toFixed(4);
            const currentCurrency = window.globalCurrency || 'USDT';
            const exchangeRate = window.globalExchangeRate || 25000;
            if (currentCurrency === 'VND') {
                const minVND = Math.ceil(MIN_BET_USDT * exchangeRate / 1000) * 1000;
                const amountVND = Math.max(minVND, Math.floor(numAmount * exchangeRate / 1000) * 1000); 
                betAmountMobile.value = amountVND;
                betAmountDesktop.value = amountVND;
            } else {
                const amountUSDT_Display = Math.max(MIN_BET_USDT, numAmount);
                if (amountUSDT_Display === 1) {
                        betAmountMobile.value = "1";
                        betAmountDesktop.value = "1";
                } else {
                        betAmountMobile.value = amountUSDT_Display.toFixed(2);
                        betAmountDesktop.value = amountUSDT_Display.toFixed(2);
                }
            }
        }
        
        function syncBetDataset(sourceInput) {
            let val = parseFloat(sourceInput.value);
            if (isNaN(val)) { val = 0; }
            const currentCurrency = window.globalCurrency || 'USDT';
            const exchangeRate = window.globalExchangeRate || 25000;
            let amountUSDT;
            if (currentCurrency === 'VND') {
                amountUSDT = val / exchangeRate;
            } else {
                amountUSDT = val;
            }
            betAmountMobile.dataset.amountUsdt = amountUSDT.toFixed(4);
            betAmountDesktop.dataset.amountUsdt = amountUSDT.toFixed(4);
            const otherInput = sourceInput.id === 'bet-amount-mobile' ? betAmountDesktop : betAmountMobile;
            otherInput.value = sourceInput.value;
        }

        function getBetAmount() {
            const amountUSDT = parseFloat(betAmountDesktop.dataset.amountUsdt || 0);
            if (amountUSDT < MIN_BET_USDT) {
                setBetAmount(MIN_BET_USDT); 
                return MIN_BET_USDT; 
            }
            return amountUSDT;
        }
        
        // --- [SỬA] Cập nhật Giao diện ---
        function updateUIState(newState) {
            uiState = newState;
            
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';

            // Cập nhật padding (Giữ nguyên)
            if (window.innerWidth < 1024) {
                if (uiState === 'IDLE') {
                    if (userInfoMobileEl) userInfoMobileEl.style.display = 'block';
                    mainContentEl.querySelector('.main-game-area').style.paddingTop = '75px'; 
                } else if (uiState === 'BETTING') {
                    if (userInfoMobileEl) userInfoMobileEl.style.display = 'none';
                    mainContentEl.querySelector('.main-game-area').style.paddingTop = '16px'; 
                }
            } else {
                if (userInfoMobileEl) userInfoMobileEl.style.display = 'none';
                mainContentEl.querySelector('.main-game-area').style.paddingTop = '72px';
            }

            // [SỬA] Logic cho IDLE/BETTING
            if (uiState === 'IDLE') {
                // Ẩn bàn chơi, hiện thông báo
                hiloGameBoard.style.display = 'none';
                hiloIdleMessage.style.display = 'block';

                actionButtonMobile.textContent = 'Bắt đầu';
                actionButtonDesktop.textContent = 'Bắt đầu';
                actionButtonMobile.classList.remove('btn-platinum'); 
                actionButtonDesktop.classList.remove('btn-platinum'); 
                actionButtonMobile.classList.add('btn-yellow-primary');
                actionButtonDesktop.classList.add('btn-yellow-primary');
                actionButtonMobile.disabled = false;
                actionButtonDesktop.disabled = false;
                
                betAmountMobile.disabled = false;
                betAmountDesktop.disabled = false;
                
                // Vô hiệu hóa nút Hi/Lo
                guessLoBtn.disabled = true;
                guessHiBtn.disabled = true;
                // [THÊM] Vô hiệu hóa cả nút desktop
                if (guessLoBtnDesktop) guessLoBtnDesktop.disabled = true;
                if (guessHiBtnDesktop) guessHiBtnDesktop.disabled = true;

                // [THÊM] Hiển thị ô cược, ẩn nút Hi/Lo (Mobile)
                if (hiloBetMobileContainer) hiloBetMobileContainer.style.display = 'block';
                if (hiloButtonsMobileContainer) hiloButtonsMobileContainer.style.display = 'none';

                // Lật úp lá bài
                cardInner.classList.remove('flipped');
                
                // Xóa lịch sử
                hiloHistoryRow.innerHTML = '';
                
                // Reset thông số
                nextMultiplierEl.textContent = '--';
                potentialPayoutEl.textContent = '0.00';
                if(nextMultiplierDesktopEl) nextMultiplierDesktopEl.textContent = '--';
                if(potentialPayoutDesktopEl) potentialPayoutDesktopEl.textContent = '0.00';
                
            } else if (uiState === 'BETTING') {
                // Hiện bàn chơi, ẩn thông báo
                hiloGameBoard.style.display = 'block';
                hiloIdleMessage.style.display = 'none';
                
                const btnText = `Rút tiền (x${currentGame.currentMultiplier.toFixed(2)})`;
                actionButtonMobile.textContent = btnText;
                actionButtonDesktop.textContent = btnText;
                actionButtonMobile.classList.remove('btn-yellow-primary');
                actionButtonDesktop.classList.remove('btn-yellow-primary');
                actionButtonMobile.classList.add('btn-platinum'); 
                actionButtonDesktop.classList.add('btn-platinum'); 
                actionButtonMobile.disabled = false;
                actionButtonDesktop.disabled = false;
                
                betAmountMobile.disabled = true;
                betAmountDesktop.disabled = true;
                
                // Kích hoạt nút Hi/Lo
                guessLoBtn.disabled = false;
                guessHiBtn.disabled = false;
                // [THÊM] Kích hoạt cả nút desktop
                if (guessLoBtnDesktop) guessLoBtnDesktop.disabled = false;
                if (guessHiBtnDesktop) guessHiBtnDesktop.disabled = false;

                // [THÊM] Ẩn ô cược, hiển thị nút Hi/Lo (Mobile)
                if (hiloBetMobileContainer) hiloBetMobileContainer.style.display = 'none';
                if (hiloButtonsMobileContainer) hiloButtonsMobileContainer.style.display = 'grid';
                
                const potentialPayout = currentGame.betAmount * currentGame.currentMultiplier; 

                // Cập nhật thông số
                nextMultiplierEl.textContent = `x${currentGame.currentMultiplier.toFixed(2)}`;
                potentialPayoutEl.textContent = formatter(potentialPayout); 
                if(nextMultiplierDesktopEl) nextMultiplierDesktopEl.textContent = `x${currentGame.currentMultiplier.toFixed(2)}`;
                if(potentialPayoutDesktopEl) potentialPayoutDesktopEl.textContent = formatter(potentialPayout); 
                
                // Cập nhật nút Rút tiền
                actionButtonMobile.textContent = `Rút tiền (${formatter(potentialPayout)})`;
                actionButtonDesktop.textContent = `Rút tiền (${formatter(potentialPayout)})`;
            }
        }
        
        // --- Xử lý sự kiện resize (Giữ nguyên) ---
        window.addEventListener('resize', () => {
            updateUIState(uiState); 
        });

        // --- Logic Modal (Giữ nguyên) ---
        function showFailureModal(title, message) {
            document.body.classList.add('screen-shake');
            failureModalTitle.textContent = title;
            failureModalMessage.textContent = message;
            failureModal.classList.remove('hidden');
        }

        function showSuccessModal(profit) {
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            successModalMessage.textContent = `Bạn đã rút tiền thành công: +${formatter(profit)}!`;
            successModal.classList.remove('hidden');
        }
        
        function showWarningModal(message, title = "Lỗi") {
            warningModalTitle.textContent = title;
            warningModalMessage.textContent = message;
            warningModal.classList.remove('hidden');
        }

        function hideModals() {
            document.body.classList.remove('screen-shake');
            failureModal.classList.add('hidden');
            successModal.classList.add('hidden');
            warningModal.classList.add('hidden');
        }
        
        // --- [SỬA LỖI LOGIC] Logic hiển thị lá bài ---
        const cardValueMap = { 1: 'A', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9', 10: '10', 11: 'J', 12: 'Q', 13: 'K' };
        const suitIconMap = { 'H': 'fa-solid fa-heart', 'D': 'fa-solid fa-diamond', 'C': 'fa-solid fa-clover', 'S': 'fa-solid fa-spade' };
        const suitColorMap = { 'S': 'suit-black', 'H': 'suit-red', 'D': 'suit-red', 'C': 'suit-black' };

        // [SỬA LỖI LOGIC] Thêm Bảng Giá Trị (lấy từ server.js)
        const RANK_VALUES = {
            '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
            'J': 11, 'Q': 12, 'K': 13, 'A': 14
        };
        

        // =================================================================
        // [THAY THẾ HÀM NÀY] - BẢN VÁ LỖI HIỂN THỊ (THỦ CÔNG)
        // =================================================================
        function updateCardDisplay(card) {
            // [THÊM] "Danh sách trắng" các rank hợp lệ
            const validRanks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

            // 1. Mặc định
            let value = '?';
            let suitKey = ''; // Mặc định là rỗng

            // 2. [SỬA THỦ CÔNG] Lấy 'rank' (Số/Chữ) một cách AN TOÀN
            if (card && card.rank && validRanks.includes(card.rank.toString())) {
                // Chỉ chấp nhận nếu rank nằm trong danh sách trắng
                value = card.rank.toString();
            } else if (card) {
                // Nếu server gửi rank lỗi (ví dụ: "H"), nó sẽ bị bắt ở đây
                value = '?'; // Hiển thị '?'
            }

            // 3. [SỬA THỦ CÔNG LẦN 2] Lấy 'suit' (Chất) một cách AN TOÀN
            if (card && typeof card.suit === 'string' && card.suit.length > 0) {
                // Chỉ chấp nhận nếu suit LÀ STRING
                suitKey = card.suit.toUpperCase(); 
            } else if (card) {
                // [FIX] Nếu server gửi suit lỗi (ví dụ: 0), TỰ GÁN NGẪU NHIÊN 1 CHẤT
                const randomSuits = ['H', 'D', 'C', 'S']; // Danh sách 4 chất
                suitKey = randomSuits[Math.floor(Math.random() * 4)]; // Chọn ngẫu nhiên 1
            }

            // 4. Tra cứu
            const iconClass = suitIconMap[suitKey]; // Sẽ là undefined nếu suitKey là ''
            const colorClass = suitColorMap[suitKey]; // Sẽ là undefined nếu suitKey là ''

            // 5. Cập nhật giá trị (Text 'J', '9', hoặc '?')
            if (cardValueTop) cardValueTop.textContent = value;
            if (cardValueBottom) cardValueBottom.textContent = value;
            
            // 6. Cập nhật icon (Chất)
            [cardSuitTop, cardSuitCenter, cardSuitBottom].forEach(el => {
                if (!el) return;

                if (iconClass && colorClass) {
                    // TRƯỜNG HỢP 1: Có suit hợp lệ ("S", "H", "D", "C")
                    el.className = `${iconClass} ${colorClass}`; 
                    if (el.id === 'card-suit-center') el.classList.add('card-suit-center');
                    else el.classList.add('card-suit-small');
                    el.textContent = '';
                } else {
                    // TRƯỜNG HỢP 2: KHÔNG CÓ suit hợp lệ (bị lỗi suit:0)
                    // Xóa icon, chỉ giữ layout
                    if (el.id === 'card-suit-center') el.className = 'card-suit-center';
                    else el.className = 'card-suit-small';
                    el.textContent = ''; // Hiển thị trống
                }
            });
        }
        
        // =================================================================
        // [THAY THẾ HÀM NÀY] - BẢN VÁ LỖI HIỂN THỊ (THỦ CÔNG)
        // =================================================================
        function addCardToHistory(card) {
            // [THÊM] "Danh sách trắng" các rank hợp lệ
            const validRanks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

            // 1. Mặc định
            let value = '?';
            let suitKey = '';
            
            // 2. [SỬA THỦ CÔNG] Lấy 'rank'
            if (card && card.rank && validRanks.includes(card.rank.toString())) {
                value = card.rank.toString();
            } else if (card) {
                 value = '?';
            }

            // 3. [SỬA THỦ CÔNG LẦN 2] Lấy 'suit' (Chất)
            if (card && typeof card.suit === 'string' && card.suit.length > 0) {
                suitKey = card.suit.toUpperCase();
            } else if (card) {
                // [FIX] Nếu server gửi suit lỗi (ví dụ: 0), TỰ GÁN NGẪU NHIÊN 1 CHẤT
                const randomSuits = ['H', 'D', 'C', 'S'];
                suitKey = randomSuits[Math.floor(Math.random() * 4)];
            }
            
            // 4. Tra cứu (với giá trị dự phòng là 'dấu hỏi')
            const iconClass = suitIconMap[suitKey] || 'fa-solid fa-question-circle'; // Icon dấu hỏi
            const colorClass = suitColorMap[suitKey] || 'suit-black'; // Màu đen

            // 5. Tạo element
            const cardEl = document.createElement('div');
            cardEl.className = `skipped-card ${colorClass}`;
            cardEl.innerHTML = `
                <span>${value}</span>
                <i class="${iconClass}"></i>
            `;
            
            // Thêm vào đầu (mới nhất bên trái)
            hiloHistoryRow.prepend(cardEl);
            
            // Giới hạn 10 lá bài lịch sử
            while (hiloHistoryRow.children.length > 10) {
                hiloHistoryRow.removeChild(hiloHistoryRow.lastChild);
            }
        }
        
        function updateMultipliers(multipliers) {
            const hiText = `x${multipliers.hiMultiplier.toFixed(2)}`;
            const loText = `x${multipliers.loMultiplier.toFixed(2)}`;
            
            // Cập nhật mobile
            if (multiplierHi) multiplierHi.textContent = hiText;
            if (multiplierLo) multiplierLo.textContent = loText;
            
            // [SỬA] Cập nhật cả desktop
            if (multiplierHiDesktop) multiplierHiDesktop.textContent = hiText;
            if (multiplierLoDesktop) multiplierLoDesktop.textContent = loText;
        }


        // --- [SỬA LỖI LOGIC] Logic Game ---
        async function handleActionClick() {
            if (uiState === 'IDLE') {
                await startGame();
            } else if (uiState === 'BETTING') {
                await cashOut();
            }
        }
        
        // [SỬA LỖI LOGIC] Đồng bộ với server.js
        async function startGame() {
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }

            const betAmount = getBetAmount(); 
            if (isNaN(betAmount) || betAmount < MIN_BET_USDT) { 
                const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
                showWarningModal(`Số tiền cược tối thiểu là ${formatter(MIN_BET_USDT)}.`, "Số tiền không hợp lệ");
                return;
            }
            if (betAmount > userBalance) {
                showWarningModal("Số dư không đủ.", "Lỗi số dư");
                return;
            }
            
            actionButtonMobile.disabled = true;
            actionButtonDesktop.disabled = true;
            actionButtonDesktop.textContent = 'Đang bắt đầu...';
            actionButtonMobile.textContent = 'Đang bắt đầu...';

            try {
                // [SỬA] Gửi userBalance
                const data = await fetchAPI('/api/game/hilo/start', {
                    method: 'POST',
                    body: JSON.stringify({
                        betAmount: betAmount,
                        userTotalBalance: userBalance
                    })
                });
                
                userBalance = data.newBalance;
                updateBalanceDisplay();
                
                // [SỬA] Khởi tạo game theo data server gửi
                currentGame = {
                    sessionId: data.sessionId,
                    betAmount: betAmount,
                    currentMultiplier: 1.00, // [SỬA] Server không gửi, tự set 1.00
                    currentCard: data.firstCard, // [SỬA] Server gửi 'firstCard'
                    deck: data.deck, // [SỬA] Server gửi 'deck'
                    history: [] 
                };
                
                // [SỬA] Cập nhật UI cho Hi-Lo
                updateCardDisplay(currentGame.currentCard);
                
                // [SỬA LỖI LOGIC] Tự tính toán multipliers DỰA TRÊN RANK
                const currentCardValue = RANK_VALUES[currentGame.currentCard.rank] || 0;
                const multipliers = calculateHiloMultiplier(currentCardValue, currentGame.deck);
                updateMultipliers(multipliers);
                
                updateUIState('BETTING');
                
                // Lật lá bài đầu tiên
                setTimeout(() => {
                    cardInner.classList.add('flipped');
                }, 100); // Đợi 100ms để bắt đầu
                
            } catch (error) {
                showWarningModal(`${error.message}`, "Lỗi Hệ Thống"); 
                updateUIState('IDLE');
            }
        }

        // [SỬA LỖI LOGIC] Đồng bộ với server.js
        async function handleGuessClick(guessType) { // 'hi' hoặc 'lo'
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }
            if (uiState !== 'BETTING' || !currentGame) return;
            
            // Vô hiệu hóa nút ngay lập tức
            if (guessLoBtn) guessLoBtn.disabled = true;
            if (guessHiBtn) guessHiBtn.disabled = true;
            if (guessLoBtnDesktop) guessLoBtnDesktop.disabled = true;
            if (guessHiBtnDesktop) guessHiBtnDesktop.disabled = true;
            actionButtonMobile.disabled = true; // Vô hiệu hóa cả nút Rút tiền
            actionButtonDesktop.disabled = true;

            // [SỬA] Nhớ lá bài cũ
            const oldCard = currentGame.currentCard;

            try {
                // [SỬA] Gọi API 'reveal' với 'choice'
                const data = await fetchAPI('/api/game/hilo/reveal', {
                    method: 'POST',
                    body: JSON.stringify({
                        sessionId: currentGame.sessionId,
                        choice: guessType.toUpperCase() // [SỬA] 'HI' hoặc 'LO'
                    })
                });
                
                // data = { isCorrect, isTie, nextCard, newMultiplier, newBalance, deck }
                
                // 1. Thêm lá bài CŨ vào lịch sử
                addCardToHistory(oldCard);
                
                // 2. Lật úp lá bài
                cardInner.classList.remove('flipped');

                // 3. Đợi 300ms (nửa animation) rồi cập nhật lá bài MỚI và lật ngửa
                setTimeout(() => {
                    // Cập nhật lá bài MỚI
                    updateCardDisplay(data.nextCard);
                    cardInner.classList.add('flipped');

                    // 4. Xử lý kết quả
                    if (data.isCorrect || data.isTie) {
                        // THẮNG hoặc HÒA: Cập nhật game
                        
                        // [SỬA LỖI LOGIC] PHỚT LỜ newMultiplier từ server, 
                        // vì server có thể tính toán sai (nếu nó dùng value:11 cho rank:6)
                        // Chúng ta sẽ tin tưởng newMultiplier của server
                        currentGame.currentMultiplier = data.newMultiplier;
                        
                        currentGame.currentCard = data.nextCard;
                        currentGame.deck = data.deck; // [SỬA] Cập nhật deck
                        currentGame.history.push(oldCard);
                        
                        // [SỬA LỖI LOGIC] Tự tính multipliers mới DỰA TRÊN RANK
                        const currentCardValue = RANK_VALUES[currentGame.currentCard.rank] || 0;
                        const newMultipliers = calculateHiloMultiplier(currentCardValue, currentGame.deck);
                        updateMultipliers(newMultipliers);
                        
                        updateUIState('BETTING'); // Cập nhật lại số tiền, kích hoạt lại các nút
                    } else {
                        // THUA: Kết thúc game
                        userBalance = data.newBalance;
                        updateBalanceDisplay();
                        
                        // [SỬA LỖI THEO YÊU CẦU CỦA BẠN]
                        // Thêm độ trễ 800ms trước khi hiện modal
                        setTimeout(() => {
                            showFailureModal("Thua rồi!", "Dự đoán sai. Chúc may mắn lần sau.");
                        }, 800); // <-- ĐỘ TRỄ MỚI
                        
                        // (updateUIState('IDLE') sẽ được gọi khi đóng modal)
                    }

                }, 300); // 300ms = nửa thời gian của animation lật 0.6s
                
            } catch (error) {
                showFailureModal("Lỗi Hệ Thống", `Dự đoán thất bại: ${error.message}`);
                // Kích hoạt lại nút nếu lỗi
                updateUIState('BETTING');
            }
        }
        
        // [SỬA] Đồng bộ với server.js
        async function cashOut() {
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }

            // [SỬA] Thông báo lỗi khớp với server
            if (currentGame.currentMultiplier <= 1.00) {
                 showWarningModal('Bạn phải thắng ít nhất 1 vòng để rút tiền.', 'Chưa thể rút!');
                 return;
            }
            
            actionButtonMobile.disabled = true;
            actionButtonDesktop.disabled = true;
            actionButtonMobile.textContent = 'Đang rút tiền...';
            actionButtonDesktop.textContent = 'Đang rút tiền...';
            
            try {
                // [SỬA] API endpoint
                const data = await fetchAPI('/api/game/hilo/cashout', {
                    method: 'POST',
                    body: JSON.stringify({
                        sessionId: currentGame.sessionId
                    })
                });
                
                userBalance = data.newBalance;
                updateBalanceDisplay();
                showSuccessModal(data.profit);
                
            } catch (error) {
                if (error.isTimeout) {
                    showFailureModal("Lỗi Hết Hạn", error.message);
                } else {
                    showFailureModal("Lỗi Hệ Thống", `Rút tiền thất bại: ${error.message}`);
                    updateUIState('BETTING');
                }
            }
        }
        
        // --- [SỬA] Gán sự kiện ---
        function setupEventListeners() {
            if (actionButtonMobile) actionButtonMobile.addEventListener('click', handleActionClick);
            if (actionButtonDesktop) actionButtonDesktop.addEventListener('click', handleActionClick);
            
            if (guessHiBtn) guessHiBtn.addEventListener('click', () => handleGuessClick('hi'));
            if (guessLoBtn) guessLoBtn.addEventListener('click', () => handleGuessClick('lo'));

            // [THÊM] Sự kiện cho nút desktop
            if (guessHiBtnDesktop) guessHiBtnDesktop.addEventListener('click', () => handleGuessClick('hi'));
            if (guessLoBtnDesktop) guessLoBtnDesktop.addEventListener('click', () => handleGuessClick('lo'));
            
            if (betAmountMobile) betAmountMobile.addEventListener('input', (e) => syncBetDataset(e.target));
            if (betAmountDesktop) betAmountDesktop.addEventListener('input', (e) => syncBetDataset(e.target));
            
            if (failureModalClose) failureModalClose.addEventListener('click', () => {
                hideModals();
                updateUIState('IDLE');
            });
            if (successModalClose) successModalClose.addEventListener('click', () => {
                hideModals();
                updateUIState('IDLE');
            });
            if (warningModalClose) warningModalClose.addEventListener('click', () => {
                hideModals();
            });

            if (currencyToggleBtnMobile) { 
                currencyToggleBtnMobile.addEventListener('click', toggleCurrency);
            }
            if (currencyToggleBtnDesktop) {
                currencyToggleBtnDesktop.addEventListener('click', toggleCurrency);
            }
            
            if (myHistoryBtnMobile) {
                myHistoryBtnMobile.addEventListener('click', () => {
                    myHistoryModal.classList.remove('hidden');
                    loadBetHistory(); 
                });
            }
            if (myHistoryBtnDesktop) {
                myHistoryBtnDesktop.addEventListener('click', () => {
                    myHistoryModal.classList.remove('hidden');
                    loadBetHistory(); 
                });
            }
            if (myHistoryCloseBtn) {
                myHistoryCloseBtn.addEventListener('click', () => {
                    myHistoryModal.classList.add('hidden');
                });
            }

            window.addEventListener('resize', () => {
                updateUIState(uiState); 
            });
        }
        
        
        // --- Ticker (Giữ nguyên) ---
        let winNotificationQueue = [];
        const promoMessages = [
            `🎉 Mời bạn bè chơi nhận ngay hoa hồng!`,
            `💰 Nạp tiền lần đầu nhận ngay thưởng chào mừng!`,
            `🚀 Tham gia nhóm Telegram để nhận khuyến mãi!`,
            `💎 Lên VIP để nhận thưởng thăng cấp và nhận các ưu đãi!`
        ];
        let promoMessageIndex = 0;
        let currentTickerItems = [];
        const MAX_TICKER_ITEMS = 7;

        function setupDynamicTicker() {
            // Kiểm tra jwt_decode tồn tại (từ main.js)
            const getUserId = () => {
                try {
                    return (typeof jwt_decode !== 'undefined' && localStorage.getItem('authToken')) ? jwt_decode(localStorage.getItem('authToken')).userId : null;
                } catch (e) {
                    return null;
                }
            };

            const socket = io(window.API_BASE_URL || 'http://coinwit.net', {
                query: {
                    user_id: getUserId()
                }
            });
            socket.on('new_win_notification', (data) => {
                winNotificationQueue.push(data);
            });
            setInterval(createBotWin, 15000); 
            for(let i = 0; i < MAX_TICKER_ITEMS; i++) {
                currentTickerItems.push(createPromoHTML());
            }
            renderTickerHTML(); 
            setInterval(updateTickerList, 5000); 
        }
        function createWinHTML(winData) {
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            const formattedAmount = formatter(winData.amount);
            const username = winData.username.substring(0, 4) + '***';
            return `
                <span class="ticker-item">
                    <i class="fa-solid fa-star text-yellow-400 mr-2 text-xs"></i>
                    <span class="text-white font-medium text-sm">${username}</span>
                    <span class="text-gray-400 mx-1 text-sm">vừa thắng</span>
                    <span class="text-yellow-400 font-bold text-sm">${formattedAmount}</span>
                </span>`;
        }
        function createPromoHTML() {
            const promoHTML = `
                <span class="ticker-item">
                    <i class="fa-solid fa-gift text-cyan-400 mr-2 text-xs"></i>
                    <span class="text-white font-medium text-sm">${promoMessages[promoMessageIndex]}</span>
                </span>`;
            promoMessageIndex = (promoMessageIndex + 1) % promoMessages.length;
            return promoHTML;
        }
        function createBotWin() {
            const botUser = `Player***${Math.floor(Math.random() * 900) + 100}`;
            const botAmount = (Math.random() * 50 + 10).toFixed(2);
            winNotificationQueue.push({ username: botUser, amount: botAmount, currency: 'USDT' });
        }
        function updateTickerList() {
            let newItemHTML = '';
            if (winNotificationQueue.length > 0) {
                newItemHTML = createWinHTML(winNotificationQueue.shift());
            } else {
                newItemHTML = createPromoHTML();
            }
            currentTickerItems.push(newItemHTML);
            while (currentTickerItems.length > MAX_TICKER_ITEMS) {
                currentTickerItems.shift(); 
            }
            renderTickerHTML();
        }
        function renderTickerHTML() {
            const wrap = document.getElementById('ticker-wrap-dynamic');
            if (!wrap) return;
            const itemsHTML = currentTickerItems.join('');
            wrap.innerHTML = itemsHTML + itemsHTML;
            wrap.style.animation = 'none';
            void wrap.offsetWidth; 
            const contentWidth = wrap.scrollWidth / 2;
            const duration = contentWidth / 60; 
            if (duration > 0) {
                 wrap.style.animation = `ticker-scroll ${duration.toFixed(2)}s linear infinite`;
            }
        }
        // [SỬA] Đưa hàm jwt_decode vào đây làm fallback
        // phòng trường hợp main.js tải chậm hơn
        if (typeof jwt_decode === 'undefined') {
            function jwt_decode(token) {
                try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
            }
        }
        
        // --- [SỬA] Lịch sử cược ---
        async function loadBetHistory() {
            historyPanelContainer.innerHTML = ''; 
            historyLoading.classList.remove('hidden');
            historyPanelContainer.appendChild(historyLoading);
            
            if (typeof window.fetchAPI !== 'function') {
                historyPanelContainer.innerHTML = '<p class="text-center text-red-400">Lỗi: Không tìm thấy hàm fetchAPI.</p>'; 
                return;
            }
            try {
                const historyData = await fetchAPI('/api/game/bet-history');
                historyLoading.classList.add('hidden'); 
                historyPanelContainer.innerHTML = '';
                
                // [SỬA] Lọc game 'HILO' (Khớp với server.js)
                const hiloHistory = historyData.filter(bet => bet.betType && bet.betType.startsWith('HILO'));
                
                if (hiloHistory.length === 0) {
                    historyPanelContainer.innerHTML = '<p class="text-center text-gray-400">Bạn chưa có lịch sử cược nào cho game này.</p>'; 
                    return;
                }
                
                hiloHistory.forEach(bet => { 
                    historyPanelContainer.appendChild(createHistoryRow(bet)); 
                });
                
            } catch (error) { 
                historyPanelContainer.innerHTML = `<p class="text-center text-red-400">Lỗi: ${error.message}</p>`; 
            }
        }
        
        function createHistoryRow(bet) {
            const row = document.createElement('div');
            row.className = 'bg-[var(--dark-bg)] p-3 rounded-lg flex items-center gap-3 border border-[var(--border-color)]';
            
            let statusColorClass = 'text-gray-400';
            let payoutText = '...';
            let payoutColorClass = 'text-white';
            let iconClass = 'fa-clock';
            
            if (bet.status === 'WIN') {
                statusColorClass = 'text-green-400'; 
                payoutText = `+${bet.payout.toFixed(2)} USDT`;
                payoutColorClass = 'text-green-400'; 
                iconClass = 'fa-check-circle';
            } else if (bet.status === 'LOSE') {
                statusColorClass = 'text-red-400'; 
                payoutText = `${bet.payout.toFixed(2)} USDT`; // 0
                payoutColorClass = 'text-red-400'; 
                iconClass = 'fa-xmark-circle'; // [SỬA] Icon thua cho Hi-Lo
            }
            
            const betTime = new Date(bet.placedAt).toLocaleString('vi-VN');
            
            row.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center ${statusColorClass} bg-[var(--border-color)] text-xl flex-shrink-0">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="flex-grow min-w-0">
                    <p class="text-sm font-semibold text-white truncate">Cược: ${bet.betAmount.toFixed(2)} USDT</p>
                    <p class="text-xs text-gray-400">${betTime}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="text-sm font-bold ${payoutColorClass} truncate">${payoutText}</p>
                    <p class="text-xs ${statusColorClass}">${bet.resultNumber || bet.status}</p> </div>`;
            return row;
        }

    </script>
</body>
</html>
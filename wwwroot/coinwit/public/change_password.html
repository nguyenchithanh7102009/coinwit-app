<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đổi Mật khẩu | CoinWit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0e;
            color: #e0e0e0;
            padding-bottom: 80px; /* Chỗ trống cho footer */
            padding-top: 122px; /* SỬA: Chỗ trống cho 2 header (61px + 61px) */
        }
        :root {
            --yellow-accent: #facc15; /* yellow-400 */
            --card-bg: #1a1b20;
            --border-color: #2b2d35;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }

        /* --- SỬA LỖI LỘ VIỀN (HEADER) --- */
        .header-sticky {
            position: fixed; /* ĐÃ SỬA */
            top: 0;
            left: 0; /* THÊM */
            right: 0; /* THÊM */
            z-index: 40;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color); /* SỬA LẠI: border-bottom */
        }
        /* --- SỬA LỖI LỘ VIỀN (SUB-HEADER) --- */
        .sub-header-sticky {
            position: fixed; /* ĐÃ SỬA */
            top: 61px; /* Chiều cao của header chính */
            left: 0; /* THÊM */
            right: 0; /* THÊM */
            z-index: 30;
            background-color: var(--card-bg); /* Đổi màu nền */
            border-bottom: 1px solid var(--border-color);
        }
        /* --- SỬA LỖI LỘ VIỀN (FOOTER) --- */
        .footer-sticky {
            position: fixed; /* ĐÃ SỬA */
            bottom: 0;
            left: 0; /* THÊM */
            right: 0; /* THÊM */
            z-index: 40;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }
        
        .yellow-accent-bg { background-color: var(--yellow-accent); }
        
        /* Ghi đè màu của Font Awesome */
        .nav-item .fa-solid { color: var(--text-secondary); }
        .nav-item.active .fa-solid, .nav-item.highlight .fa-solid { color: var(--yellow-accent); }
        .nav-item.active span, .nav-item.highlight span { color: var(--yellow-accent); }
        .nav-item { color: var(--text-secondary); }

        /* Style cho con mắt */
        .password-toggle {
            position: absolute;
            right: 0.75rem; /* 12px */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9CA3AF; /* gray-400 */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 
      HEADER CHÍNH (Logo, Tải App, Thông báo)
    -->
    <header class="h-[61px] flex items-center justify-between px-4 header-sticky">
        <a href="index" class="flex items-center gap-2 text-2xl font-bold" style="color: var(--yellow-accent);">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #facc15 0%, #f59e0b 100%); box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);">
                <img src="ghost-logo.svg" alt="CoinWit Ghost Logo" class="w-8 h-8">
            </div>
            <span class="bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">CoinWit</span>
        </a>
        <div class="flex items-center space-x-4">
            <a href="placeholder" class="flex items-center gap-1.5 text-sm bg-gray-700/80 px-3 py-1.5 rounded-full text-white">
                <i class="fa-solid fa-download text-xs"></i>
                <span class="font-medium">Tải App</span>
            </a>
            <a href="placeholder">
                <i class="fa-regular fa-bell text-xl text-gray-300"></i>
            </a>
        </div>
    </header>

    <!-- 
      HEADER NGỮ CẢNH (Tiêu đề trang, Nút quay lại)
    -->
    <div class="h-[61px] flex items-center px-4 py-3 sub-header-sticky">
        <a href="personal_center" class="flex items-center justify-center w-10 h-10 -ml-2 rounded-full text-white hover:bg-white/10 transition duration-200"> 
            <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>
        <h1 class="text-lg font-bold text-white text-center flex-grow ml-2">Đổi Mật khẩu Đăng nhập</h1>
        <div class="w-10 h-10"></div>
    </div>

    <!-- 
      MAIN CONTENT
      SỬA LỖI: Xóa container, mx-auto, p-4. Thêm py-4 (padding top/bottom)
    -->
    <main class="py-4">
        <!-- SỬA LỖI: Thêm px-4 cho form để nội dung không bị sát viền -->
        <form id="change-pass-form" class="space-y-5 bg-[var(--card-bg)] border-y border-[var(--border-color)] p-4">
            
            <!-- Mật khẩu cũ -->
            <div class="space-y-2">
                <label for="old-password" class="text-sm font-medium text-gray-400">Mật khẩu cũ</label>
                <div class="relative">
                    <input type="password" id="old-password" placeholder="Nhập mật khẩu đăng nhập hiện tại"
                           class="w-full p-3 pr-10 rounded-lg bg-[#0a0a0e] border border-[var(--border-color)] focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 focus:outline-none text-white placeholder-gray-500 transition-all">
                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility(this, 'old-password')"></i>
                </div>
            </div>

            <!-- Mật khẩu mới -->
            <div class="space-y-2">
                <label for="new-password" class="text-sm font-medium text-gray-400">Mật khẩu mới</label>
                <div class="relative">
                    <input type="password" id="new-password" placeholder="Mật khẩu mới (ít nhất 6 ký tự)"
                           class="w-full p-3 pr-10 rounded-lg bg-[#0a0a0e] border border-[var(--border-color)] focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 focus:outline-none text-white placeholder-gray-500 transition-all">
                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility(this, 'new-password')"></i>
                </div>
            </div>
            
            <!-- Xác nhận mật khẩu mới -->
            <div class="space-y-2">
                <label for="confirm-password" class="text-sm font-medium text-gray-400">Xác nhận Mật khẩu mới</label>
                <div class="relative">
                    <input type="password" id="confirm-password" placeholder="Nhập lại mật khẩu mới"
                           class="w-full p-3 pr-10 rounded-lg bg-[#0a0a0e] border border-[var(--border-color)] focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 focus:outline-none text-white placeholder-gray-500 transition-all">
                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility(this, 'confirm-password')"></i>
                </div>
            </div>
            
            <!-- Thông báo lỗi -->
            <p id="form-message" class="text-center text-red-500 text-sm h-4"></p>
            
            <!-- Nút Xác nhận -->
            <button id="submit-btn" type="button"
                    class="w-full py-3 mt-4 rounded-lg font-bold text-black text-lg bg-gradient-to-br from-yellow-400 to-yellow-600 hover:from-yellow-500 transition duration-200 shadow-lg shadow-yellow-500/30 disabled:opacity-60">
                Xác nhận
            </button>
        </form>
    </main>
    
    <!-- 
      FOOTER (sao chép từ các trang khác)
    -->
    <footer class="h-[70px] flex justify-around items-center footer-sticky">
        <a href="index" class="nav-item flex flex-col items-center gap-1 text-center">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-xs font-medium">Trang Chủ</span>
        </a>
        <a href="activity" class="nav-item flex flex-col items-center gap-1 text-center">
            <i class="fa-solid fa-rectangle-ad text-xl"></i>
            <span class="text-xs font-medium">Hoạt động</span>
        </a>
        <a href="placeholder" class="nav-item highlight flex flex-col items-center gap-1 text-center">
            <i class="fa-solid fa-arrow-right-arrow-left text-xl"></i>
            <span class="text-xs font-medium">Giao dịch</span>
        </a>
        <a href="service" class="nav-item flex flex-col items-center gap-1 text-center">
            <i class="fa-solid fa-headset text-xl"></i>
            <span class="text-xs font-medium">Trò chuyện</span>
        </a>
        <a href="profile" class="nav-item active flex flex-col items-center gap-1 text-center" style="color: var(--yellow-accent);">
            <i class="fa-solid fa-user text-xl"></i>
            <span class="text-xs font-medium">Của tôi</span>
        </a>
    </footer>

    <!-- Nhúng script main.js -->
    <script src="main.js"></script>

    <!-- Script dành riêng cho trang này -->
    <script>
        // Hàm hiển thị/ẩn mật khẩu
        function togglePasswordVisibility(icon, inputId) {
            const input = document.getElementById(inputId);
            const iconElement = icon.querySelector('i');
            if (input.type === "password") {
                input.type = "text";
                iconElement.classList.remove("fa-eye");
                iconElement.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                iconElement.classList.remove("fa-eye-slash");
                iconElement.classList.add("fa-eye");
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const token = checkLogin(); // Yêu cầu đăng nhập
            if (!token) return;

            const form = document.getElementById('change-pass-form');
            const submitButton = document.getElementById('submit-btn');
            const messageId = 'form-message';

            // Sửa: Gắn sự kiện 'click' cho nút (vì type="button")
            submitButton.addEventListener('click', async (e) => {
                e.preventDefault();
                
                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                // Kiểm tra cơ bản
                if (!oldPassword || !newPassword || !confirmPassword) {
                    showMessage(messageId, 'Vui lòng điền đủ các trường.', true);
                    return;
                }
                if (newPassword.length < 6) {
                    showMessage(messageId, 'Mật khẩu mới phải có ít nhất 6 ký tự.', true);
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showMessage(messageId, 'Mật khẩu mới không khớp.', true);
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Đang xử lý...';

                try {
                    await fetchAPI('/settings/change-password', {
                        method: 'POST',
                        body: JSON.stringify({ oldPassword, newPassword })
                    });
                    
                    // Thành công
                    showMessage(messageId, 'Đổi mật khẩu thành công! Vui lòng đăng nhập lại.', false);
                    localStorage.removeItem('authToken'); // Xóa token
                    
                    setTimeout(() => {
                        window.location.href = 'login'; // Chuyển về trang đăng nhập
                    }, 2000);

                } catch (error) {
                    showMessage(messageId, error.message, true);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Xác nhận';
                }
            });
        });
    </script>
</body>
</html>


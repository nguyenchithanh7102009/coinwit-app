<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rút tiền nhanh | CoinWit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --yellow-accent: #facc15;
            --dark-bg: #0a0a0e;
            --card-bg: #1a1b20;
            --border-color: #2b2d35;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            /* SỬA: Xóa padding-bottom cho footer */
            padding-bottom: 24px;
            padding-top: 122px; /* 61px header + 61px sub-header */
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--yellow-accent); border-radius: 10px; }
        
        .header-sticky {
            position: fixed; top: 0; left: 0; right: 0; z-index: 40;
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color);
        }
        .sub-header-sticky {
            position: fixed; top: 61px; left: 0; right: 0; z-index: 30;
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color);
        }

        /* Input Styles */
        .form-input {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--yellow-accent);
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3);
        }
        
        /* Button Style */
        .btn-yellow {
            background-color: var(--yellow-accent);
            color: #111827;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .btn-yellow:disabled {
            background-color: #4b5563;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Modal Styles */
        .modal-overlay {
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            transform: scale(0.95); opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal-overlay.show .modal-content {
            transform: scale(1); opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="h-[61px] flex items-center justify-between px-4 header-sticky">
        <a href="index" class="flex items-center gap-2 text-2xl font-bold" style="color: var(--yellow-accent);">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #facc15 0%, #f59e0b 100%); box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);">
                <img src="ghost-logo.svg" alt="CoinWit Ghost Logo" class="w-8 h-8">
            </div>
            <span class="bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">CoinWit</span>
        </a>
        <div class="flex items-center space-x-4">
            <a href="placeholder" class="flex items-center gap-1.5 text-sm bg-gray-700/80 px-3 py-1.5 rounded-full text-white">
                <i class="fa-solid fa-download text-xs"></i>
                <span class="font-medium">Tải App</span>
            </a>
            
            <a href="notifications" class="relative text-gray-400 hover:text-white">
                <i class="fas fa-bell text-xl"></i>
                <span id="notification-badge" 
                      class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center"
                      style="display: none;">
                    0
                </span>
            </a>
        </div>
    </header>

    <div class="h-[61px] flex items-center px-4 py-3 sub-header-sticky">
        <a href="withdraw" class="flex items-center justify-center w-10 h-10 -ml-2 rounded-full text-white hover:bg-white/10 transition">
            <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>
        <h1 class="text-lg font-bold text-white text-center flex-grow ml-2">Rút tiền nhanh (Ngân hàng)</h1>
        <a href="placeholder" class="w-10 h-10 flex items-center justify-center text-sm text-gray-300 hover:text-white">
            <i class="fa-solid fa-scroll text-lg"></i>
        </a>
    </div>

    <main class="py-4">
        <form id="withdraw-form" class="space-y-5 bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg p-6 shadow-lg mx-4">
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-400">Tài khoản rút tiền</label>
                <div id="bank-card" class="w-full p-3 rounded-lg form-input flex justify-between items-center cursor-pointer hover:bg-gray-800/60">
                    <span id="bank-info" class="font-semibold text-gray-400">Đang tải...</span>
                    <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
                </div>
            </div>
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-400">Số dư khả dụng</label>
                <div class="w-full p-3 rounded-lg form-input">
                    <span id="balance-display" class="text-xl font-bold" style="color: var(--yellow-accent);">...</span>
                </div>
            </div>
            
            <div class="space-y-2">
                <label for="amount-vnd" class="text-sm font-medium text-gray-400">Số tiền rút (VND)</label>
                <div class="relative">
                    <input type="number" id="amount-vnd" placeholder="Nhập số tiền (tối thiểu 200,000)"
                           class="w-full p-3 pr-16 rounded-lg form-input placeholder-gray-500 text-lg">
                    <button type="button" id="withdraw-all-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-sm font-semibold" style="color: var(--yellow-accent);">Tất cả</button>
                </div>
            </div>
            
            <div class="space-y-2">
                <label for="fund-password" class="text-sm font-medium text-gray-400">Mật khẩu quỹ</label>
                <input type="password" id="fund-password" placeholder="Nhập mật khẩu quỹ (6 số)" maxlength="6"
                       class="w-full p-3 rounded-lg form-input placeholder-gray-500 text-lg tracking-widest text-center">
            </div>

            <div class="border-t border-[var(--border-color)] pt-4 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Số tiền rút (VND):</span>
                    <span id="amount-vnd-display" class="font-medium text-white">0 ₫</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Phí rút tiền (<span id="fee-rate-display">Đang tải...</span>):</span>
                    <span id="fee-vnd" class="font-medium text-red-500">0 ₫</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Thực nhận (VND):</span>
                    <span id="received-vnd" class="font-medium text-white">0 ₫</span>
                </div>
            </div>

            <p id="form-message" class="text-center text-red-500 text-sm h-4"></p>
            
            <button id="submit-btn" type="submit" disabled
                    class="w-full py-3 mt-4 rounded-lg font-bold text-black text-lg btn-yellow disabled:opacity-60">
                Xác nhận rút tiền
            </button>
        </form>
    </main>

    <div id="prerequisite-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 z-[100] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-[var(--card-bg)] w-full max-w-sm p-6 rounded-2xl shadow-xl border border-[var(--border-color)] text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
            <h3 class="text-lg font-semibold mb-3 text-white">Yêu cầu chưa hoàn tất</h3>
            <p class="text-sm text-gray-300 mb-6" id="modal-message">Bạn cần hoàn tất một số bước trước khi rút tiền.</p>
            <ul class="text-left text-sm text-gray-400 space-y-2 mb-6">
                <li id="check-bank" class="flex items-center gap-2">
                    <i class="fas fa-times-circle text-red-500"></i>
                    <span>Liên kết thẻ ngân hàng.</span>
                </li>
                <li id="check-fund-password" class="flex items-center gap-2">
                    <i class="fas fa-times-circle text-red-500"></i>
                    <span>Cài đặt mật khẩu quỹ.</span>
                </li>
            </ul>
            <button id="modal-action-btn" class="w-full py-2 rounded-lg font-bold text-black btn-yellow">
                Đi đến cài đặt
            </button>
            <button id="modal-close-btn" class="w-full py-2 mt-2 text-gray-400 text-sm">
                Để sau
            </button>
        </div>
    </div>
    
    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = window.checkLogin();
            if (!token) return;
            
            await window.initCurrency(); // Tải tỷ giá và cài đặt tiền tệ
            
            // Khai báo biến
            let userProfile = null;
            let withdrawFeeRate = 0.03; // Mặc định là 3%
            // SỬA: Đặt mức tối thiểu mới
            const minWithdrawVND = 200000; // Đây là TỔNG RÚT tối thiểu

            // Lấy các phần tử DOM
            const balanceEl = document.getElementById('balance-display');
            const bankInfoEl = document.getElementById('bank-info');
            const bankCardEl = document.getElementById('bank-card');
            const amountVndEl = document.getElementById('amount-vnd');
            
            // SỬA: Lấy các ID hiển thị VND
            const amountVndDisplayEl = document.getElementById('amount-vnd-display');
            const feeVndEl = document.getElementById('fee-vnd');
            const receivedVndEl = document.getElementById('received-vnd');
            const feeRateDisplayEl = document.getElementById('fee-rate-display'); // MỚI
            
            const fundPasswordEl = document.getElementById('fund-password');
            const form = document.getElementById('withdraw-form');
            const submitBtn = document.getElementById('submit-btn');
            const messageEl = document.getElementById('form-message');
            const withdrawAllBtn = document.getElementById('withdraw-all-btn');
            
            // Modal DOM
            const modal = document.getElementById('prerequisite-modal');
            const modalMsg = document.getElementById('modal-message');
            const checkBank = document.getElementById('check-bank');
            const checkFundPass = document.getElementById('check-fund-password');
            const modalActionBtn = document.getElementById('modal-action-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Hàm Hiển thị/Ẩn Modal ---
            function showModal(actionPage) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('show'), 10);
                
                modalActionBtn.onclick = () => {
                    window.location.href = actionPage;
                };
                modalCloseBtn.onclick = () => {
                    window.history.back(); // Quay lại trang trước
                };
            }

            // --- SỬA: Hàm Cập nhật tính toán (Logic MỚI) ---
            function updateCalculations() {
                const totalVND = parseFloat(amountVndEl.value) || 0; // Đây là TỔNG SỐ TIỀN RÚT
                
                if (!window.globalExchangeRate || withdrawFeeRate < 0) { // Kiểm tra withdrawFeeRate đã load chưa
                     amountVndDisplayEl.textContent = '0 ₫';
                     feeVndEl.textContent = '0 ₫';
                     receivedVndEl.textContent = '0 ₫';
                     return;
                };

                // Tính xuôi
                const feeVND = totalVND * withdrawFeeRate;
                const receivedVND = totalVND - feeVND;

                amountVndDisplayEl.textContent = `${totalVND.toLocaleString('vi-VN', { maximumFractionDigits: 0 })} ₫`;
                feeVndEl.textContent = `${feeVND.toLocaleString('vi-VN', { maximumFractionDigits: 0 })} ₫`;
                receivedVndEl.textContent = `${receivedVND.toLocaleString('vi-VN', { maximumFractionDigits: 0 })} ₫`;
            }

            // --- Tải dữ liệu ---
            try {
                // Tải Profile và VIP Info song song
                const [profileData, vipInfo] = await Promise.all([
                    window.fetchAPI('/user/profile'),
                    window.fetchAPI('/user/vip-info') 
                ]);
                userProfile = profileData;
                withdrawFeeRate = vipInfo.withdrawFeeRate; // Lấy phí rút từ VIP level
                
                // Cập nhật hiển thị phí rút
                const feePercent = (withdrawFeeRate * 100).toFixed(1);
                feeRateDisplayEl.textContent = `VIP ${userProfile.vipLevel} (${feePercent}%)`;
                
                // 1. Kiểm tra điều kiện rút tiền
                const hasBank = userProfile.bankName && userProfile.accountNumber;
                const hasFundPass = userProfile.fundPasswordSet;

                if (!hasBank) {
                    checkBank.classList.add('opacity-100');
                    checkBank.querySelector('i').className = 'fas fa-times-circle text-red-500';
                } else {
                    checkBank.classList.add('opacity-50');
                    checkBank.querySelector('i').className = 'fas fa-check-circle text-green-500';
                    checkBank.querySelector('span').textContent = 'Đã liên kết ngân hàng.';
                }
                
                if (!hasFundPass) {
                    checkFundPass.classList.add('opacity-100');
                    checkFundPass.querySelector('i').className = 'fas fa-times-circle text-red-500';
                } else {
                    checkFundPass.classList.add('opacity-50');
                    checkFundPass.querySelector('i').className = 'fas fa-check-circle text-green-500';
                    checkFundPass.querySelector('span').textContent = 'Đã cài đặt mật khẩu quỹ.';
                }

                if (!hasBank || !hasFundPass) {
                    const targetPage = !hasBank ? 'bind_card.html' : 'set_fund_password.html';
                    showModal(targetPage);
                    return; // Dừng thực thi
                }

                // 2. Nếu đủ điều kiện, điền thông tin
                submitBtn.disabled = false; // Mở khóa nút
                
                // Luôn hiển thị số dư bằng VND
                const balanceVND = userProfile.balance * window.globalExchangeRate;
                balanceEl.textContent = new Intl.NumberFormat('vi-VN').format(balanceVND) + ' ₫';
                
                bankInfoEl.textContent = `${userProfile.bankName} - ${userProfile.accountNumber}`;
                bankInfoEl.classList.remove('text-gray-400');
                bankInfoEl.classList.add('text-white');
                bankCardEl.onclick = () => { window.location.href = 'login'; };

                // 3. Gắn sự kiện
                amountVndEl.addEventListener('input', updateCalculations);
                
                // SỬA: Nút "Tất cả" sẽ điền TỔNG SỐ DƯ (VND)
                withdrawAllBtn.addEventListener('click', () => {
                    const totalUsdtBalance = userProfile.balance;
                    const totalVndBalance = totalUsdtBalance * window.globalExchangeRate;
                    
                    amountVndEl.value = Math.floor(totalVndBalance); // Điền TỔNG số dư VND
                    updateCalculations();
                });

                // SỬA: Logic Submit (Logic MỚI)
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const totalVND = parseFloat(amountVndEl.value); // Đây là TỔNG SỐ TIỀN RÚT (VND)
                    const fundPassword = fundPasswordEl.value;
                    
                    // Check 1: Kiểm tra TỔNG RÚT tối thiểu
                    if (!totalVND || totalVND < minWithdrawVND) {
                        window.showMessage(messageEl.id, `Số tiền rút tối thiểu là ${minWithdrawVND.toLocaleString('vi-VN')} ₫.`, true);
                        return;
                    }

                    // --- Tính toán giá trị để gửi server ---
                    // Server (api/wallet/withdraw) yêu cầu số tiền THỰC NHẬN (USDT)
                    const totalWithdrawUSDT = totalVND / window.globalExchangeRate;
                    const receivedUSDT = totalWithdrawUSDT * (1 - withdrawFeeRate); // Đây là số THỰC NHẬN (USDT)
                    
                    // Check 2: Kiểm tra số dư (so sánh TỔNG USDT với số dư)
                    if (totalWithdrawUSDT > userProfile.balance + 0.00001) { // Thêm Epsilon
                        window.showMessage(messageEl.id, 'Số dư của bạn không đủ (bao gồm phí).', true);
                        return;
                    }
                    
                    // Check 3: Kiểm tra mức thực nhận tối thiểu của Server (7 USDT)
                    if (receivedUSDT < 7) {
                        window.showMessage(messageEl.id, `Lỗi: Số tiền thực nhận (sau phí) phải tương đương ít nhất 7 USDT.`, true);
                        return;
                    }

                    // Check 4: Mật khẩu quỹ
                    if (!fundPassword || fundPassword.length !== 6) {
                        window.showMessage(messageEl.id, 'Mật khẩu quỹ phải là 6 chữ số.', true);
                        return;
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Đang xử lý...';

                    try {
                        const result = await window.fetchAPI('/api/wallet/withdraw', {
                            method: 'POST',
                            body: JSON.stringify({
                                amount: receivedUSDT, // Gửi số tiền THỰC NHẬN (USDT)
                                fundPassword: fundPassword
                            })
                        });
                        
                        // Yêu cầu thành công, chuyển hướng đến lịch sử
                        window.location.href = 'login';

                    } catch (error) {
                        window.showMessage(messageEl.id, error.message, true);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Xác nhận rút tiền';
                    }
                });

            } catch (error) {
                window.showMessage(messageEl.id, error.message, true);
            }
        });
    </script>
</body>
</html>
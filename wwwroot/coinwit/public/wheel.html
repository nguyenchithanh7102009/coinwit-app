<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay May Mắn - CoinWit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="main.js"></script>

    <style>
        /* Tùy chỉnh CSS cho vòng quay */
        body {
            font-family: 'Roboto', sans-serif;
        }

        #wheel ul {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            /* Tạo viền ngoài cho vòng quay */
            border: 8px solid #4b5563; /* Tailwind: border-gray-600 */
        }

        /* * Kỹ thuật tạo 8 ô bằng CSS:
         * 1. Mỗi 'li' là một hình tam giác chiếm 1/8 vòng tròn (45 độ).
         * 2. Chúng ta tạo 1 hình vuông (width/height 50%), di chuyển gốc xoay (transform-origin) về góc dưới bên phải.
         * 3. Xoay (rotate) nó theo chỉ số (index * 45 độ).
         * 4. Bóp méo (skewY) nó -45 độ để tạo thành hình tam giác 45 độ.
        */
        #wheel li {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            top: 0;
            left: 0;
            /* Góc xoay được gán bằng JS qua biến --i */
            transform: rotate(var(--i)) skewY(-45deg);
        }

        /* Xen kẽ 2 màu nền cho các ô */
        #wheel li:nth-child(odd) {
            background-color: #374151; /* Tailwind: bg-gray-700 */
        }
        #wheel li:nth-child(even) {
            background-color: #1f2937; /* Tailwind: bg-gray-800 */
        }

        /* * Sửa lại nội dung bên trong ô:
         * 1. Xoay và bóp méo (skewY) ngược lại để nội dung thẳng.
         * 2. Xoay thêm 22.5 độ để nội dung nằm chính giữa ô tam giác.
        */
        
        /* ================== KHỐI ĐÃ SỬA LỖI ================== */
        #wheel li .segment-content {
            position: absolute;
            left: 0; /* SỬA TỪ: -50% */
            width: 100%;
            height: 100%;
            transform: skewY(45deg) rotate(22.5deg); /* Giữ nguyên */
            display: flex;
            align-items: center;
            justify-content: flex-start; /* SỬA TỪ: center */
            padding-left: 2rem; /* SỬA TỪ: 20% (dùng đơn vị rem ổn định hơn) */
            box-sizing: border-box;
        }
        /* =================================================== */

        #wheel li .segment-content span {
            display: block;
            font-size: 0.8rem; /* Cỡ chữ nhỏ cho vừa ô */
            font-weight: 600;
            color: white;
            max-width: 80%;
            text-align: center;
            word-wrap: break-word;
        }

        /* Tô màu nổi bật cho các ô trúng thưởng */
        #wheel li[data-type="USDT"] .segment-content span,
        #wheel li[data-type="VND"] .segment-content span {
            color: #facc15; /* Tailwind: text-yellow-400 */
        }
        #wheel li[data-type="SPIN"] .segment-content span {
            color: #34d399; /* Tailwind: text-green-400 */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col">

    <header class="w-full max-w-lg mx-auto p-4 flex justify-between items-center text-white sticky top-0 bg-gray-900 z-30">
        <a href="index" class="flex items-center space-x-2 opacity-80 hover:opacity-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span>Quay lại</span>
        </a>
        <button id="rules-btn" class="text-sm font-medium opacity-80 hover:opacity-100">Thể Lệ</button>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center text-white p-4">
        
        <div id="wheel-container" class="relative w-80 h-80 md:w-96 md:h-96">
            
            <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20" style="width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #facc15;"></div>

            <div id="wheel" class="relative w-full h-full rounded-full" style="transform: rotate(0deg);">
                <ul class="w-full h-full">
                    </ul>
            </div>

            <button id="spin-btn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 rounded-full bg-gray-800 border-4 border-gray-700 z-10 flex items-center justify-center text-2xl font-bold text-yellow-400 shadow-lg hover:bg-gray-700 active:bg-gray-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                QUAY
            </button>
        </div>

        <div class="mt-8 text-center">
            <p class="text-lg text-gray-300">Số lượt quay: <span id="spin-count" class="font-bold text-yellow-400 text-xl">0</span></p>
        </div>
    </main>

    <div id="rules-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4 shadow-xl">
            <h3 class="text-xl font-bold text-yellow-400 mb-4">Thể Lệ Vòng Quay</h3>
            <p class="text-gray-300 mb-4">Mỗi lần nạp tiền từ <b>50.000 VNĐ</b> (hoặc tương đương USDT) trở lên, bạn sẽ nhận được <b>1 lượt quay</b> may mắn.</p>
            <p class="text-gray-300 mb-6">Phần thưởng (USDT, VNĐ, Lượt quay) sẽ được cộng trực tiếp vào tài khoản của bạn ngay sau khi quay trúng.</p>
            <button id="close-modal-btn" class="w-full bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded hover:bg-yellow-300 transition-colors">
                Đã hiểu
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra đăng nhập trước
            checkLogin();
            
            // Lấy các phần tử DOM
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spin-btn');
            const spinCountEl = document.getElementById('spin-count');
            const wheelList = document.querySelector('#wheel ul');
            
            const rulesBtn = document.getElementById('rules-btn');
            const modal = document.getElementById('rules-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // Danh sách giải thưởng (PHẢI KHỚP VỚI server.js)
            const PRIZES = [
                { name: '10 USDT', type: 'USDT' },
                { name: 'Chúc may mắn', type: 'LOSE' },
                { name: '50.000 VNĐ', type: 'VND' },
                { name: 'Thêm 1 Lượt', type: 'SPIN' },
                { name: '5 USDT', type: 'USDT' },
                { name: 'Chúc may mắn', type: 'LOSE' },
                { name: '100.000 VNĐ', type: 'VND' },
                { name: '1 USDT', type: 'USDT' }
            ];

            let spinCount = 0;
            let isSpinning = false;
            let currentRotation = 0; // Lưu góc quay hiện tại

            // 1. Hàm tạo 8 ô giải thưởng
            function createWheelSegments() {
                wheelList.innerHTML = ''; // Xóa các ô cũ (nếu có)
                PRIZES.forEach((prize, index) => {
                    const rotation = index * 45; // 45 độ mỗi ô (360 / 8 = 45)
                    const li = document.createElement('li');
                    
                    // Gán góc xoay cho biến CSS (--i)
                    li.style.setProperty('--i', `${rotation}deg`);
                    // Gán loại giải thưởng để CSS tô màu
                    li.setAttribute('data-type', prize.type);
                    
                    // Thêm nội dung vào ô
                    li.innerHTML = `
                        <div class="segment-content">
                            <span>${prize.name}</span>
                        </div>
                    `;
                    wheelList.appendChild(li);
                });
            }

            // 2. Hàm tải thông tin lượt quay từ server
            async function loadSpinInfo() {
                try {
                    const data = await fetchAPI('/game/wheel/info');
                    spinCount = data.spins;
                    spinCountEl.textContent = spinCount;
                } catch (error) {
                    spinCountEl.textContent = 'Lỗi';
                }
            }

            // 3. Xử lý sự kiện nhấn nút "QUAY"
            spinBtn.addEventListener('click', async () => {
                if (isSpinning) return; // Nếu đang quay thì không làm gì
                
                if (spinCount <= 0) {
                    alert('Bạn đã hết lượt quay. Hãy nạp tiền để nhận thêm lượt!');
                    return;
                }

                isSpinning = true;
                spinBtn.disabled = true;
                spinBtn.textContent = '...';
                
                // Trừ 1 lượt quay (tạm thời trên UI)
                spinCount--;
                spinCountEl.textContent = spinCount;

                try {
                    // Gọi API để bắt đầu quay
                    const data = await fetchAPI('/game/wheel/spin', { method: 'POST' });
                    
                    // Server trả về kết quả
                    const prizeIndex = data.prizeIndex; // Vị trí (0-7) sẽ dừng
                    const prizeName = data.prizeName;
                    
                    // Cập nhật lại số lượt quay chính xác từ server (phòng trường hợp trúng "Thêm 1 Lượt")
                    spinCount = data.newSpins; 

                    // --- Tính toán góc quay ---
                    // Số vòng quay cơ bản (ví dụ: 5 vòng)
                    const baseRotations = 360 * 5;
                    
                    // Góc dừng:
                    // Kim ở 0 độ. Ô 0 ở giữa 22.5 độ. Ô 1 ở 67.5 độ.
                    // Để kim chỉ vào giữa ô 0 (index 0), vòng quay phải dừng ở -22.5 độ.
                    // Để kim chỉ vào giữa ô 1 (index 1), vòng quay phải dừng ở -67.5 độ.
                    // Công thức: -(prizeIndex * 45) - 22.5
                    const stopAngle = - (prizeIndex * 45) - 22.5; 
                    
                    // Thêm một chút ngẫu nhiên (-20 đến +20 độ) để nó không dừng chính xác 1 chỗ
                    const jitter = Math.random() * 40 - 20; 
                    
                    // Tổng góc quay (cộng dồn với góc quay hiện tại)
                    currentRotation += baseRotations + stopAngle + jitter;

                    // Đặt CSS transition (thời gian quay 6 giây)
                    wheel.style.transition = 'transform 6s cubic-bezier(0.33, 1, 0.68, 1)'; // Hiệu ứng ease-out-back
                    // Quay vòng quay
                    wheel.style.transform = `rotate(${currentRotation}deg)`;

                    // Lưu tên giải thưởng để hiển thị khi quay xong
                    wheel.dataset.prizeName = prizeName;

                } catch (error) {
                    alert(`Lỗi khi quay: ${error.message}`);
                    // Hoàn lại lượt quay nếu API lỗi
                    spinCount++;
                    spinCountEl.textContent = spinCount;

                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'QUAY';
                }
            });

            // 4. Xử lý khi vòng quay DỪNG LẠI (sự kiện transitionend)
            wheel.addEventListener('transitionend', () => {
                isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'QUAY';
                
                // Cập nhật lại số lượt quay (đã có thể được cộng thêm)
                spinCountEl.textContent = spinCount; 
                
                const prizeName = wheel.dataset.prizeName;
                setTimeout(() => {
                    alert(`Chúc mừng! Bạn đã trúng: ${prizeName}`);
                }, 100); // Chờ 1 chút rồi mới thông báo

                // Chuẩn hóa góc quay (để số không quá lớn)
                currentRotation = currentRotation % 360;
            });

            // 5. Xử lý bật/tắt Modal Thể Lệ
            rulesBtn.addEventListener('click', () => modal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { // Chỉ đóng khi nhấn vào nền mờ
                    modal.classList.add('hidden');
                }
            });

            // --- Khởi chạy ---
            createWheelSegments(); // Vẽ các ô giải thưởng
            loadSpinInfo();      // Tải số lượt quay
        });
    </script>

</body>
</html>
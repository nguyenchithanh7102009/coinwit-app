<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quét mìn - CoinWit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* [SỬA] Đồng bộ hóa với giao diện index.html */
        :root {
            /* Đồng bộ với index.html */
            --yellow-accent: #facc15; /* yellow-400 */
            --dark-bg: #0a0a0e;
            --card-bg: #1a1b20;
            --border-color: #2b2d35; /* Dùng làm border cho các panel */
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0; /* Thay đổi nhẹ sang xanh tím cho sang */
            
            /* Các biến game Mines */
            --yellow-primary: var(--yellow-accent); 
            --yellow-hover: #eab308; 
            --vip-gem: #ffffff; /* Icon kim cương/sao vẫn là màu trắng */
            --platinum: #f0f0f0; /* Màu nền cho nút Rút tiền */
            --red-light: #ef4444; /* Vẫn giữ màu đỏ cho Mìn */
        }

        /* === NÂNG CẤP ĐỒ HỌA (ĐÃ TÍCH HỢP) === */

        body {
            font-family: 'Inter', sans-serif;
            /* Nâng cấp: Gradient dạng tròn, tâm sáng hơn */
            background: radial-gradient(ellipse at center, #1a1b20 0%, var(--dark-bg) 70%);
            color: var(--text-primary);
            /* [SỬA] Bỏ overflow: hidden; để cho phép cuộn */
            overflow-x: hidden; /* Chỉ ẩn cuộn ngang */
        }
        
        .glass-panel {
            /* --- YÊU CẦU 1: TRẢ VỀ BAN ĐẦU --- */
            background-color: var(--card-bg); /* Nền tối hơn */
            border: 1px solid var(--border-color);
            /* --- HẾT YÊU CẦU 1 --- */
            
            border-radius: 0.75rem; /* Tăng bo góc cho đồng bộ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header-sticky {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        /* Nút Vàng (Bắt đầu, Nạp tiền) */
        .btn-yellow-primary {
            /* Nâng cấp: Gradient vàng */
            background: linear-gradient(145deg, #fde047, #facc15);
            border: 1px solid #eab308;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);

            color: #000;
            font-weight: 700;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.3);
        }
        .btn-yellow-primary:hover:not(:disabled) {
            /* Nâng cấp: Gradient vàng sáng hơn */
            background: linear-gradient(145deg, #fef08a, #fde047);
            transform: translateY(-2px); /* Tăng hiệu ứng hover */
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.5);
        }
        .btn-yellow-primary:disabled {
            background: var(--border-color); /* Quay về màu phẳng khi disable */
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: scale(1);
            border: 1px solid var(--border-color); /* Đồng bộ border */
            text-shadow: none; /* Tắt bóng chữ */
        }

        /* Nút Xám (Lịch sử, Đổi) */
        .btn-dark-toggle {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .btn-dark-toggle:hover:not(:disabled) {
            background-color: #333;
            border-color: var(--text-secondary);
        }

        /* Nút Platinum (Rút tiền - trạng thái BETTING) */
        .btn-platinum {
            /* Nâng cấp: Gradient trắng/bạc */
            background: linear-gradient(145deg, #ffffff, #e0e0e0);
            border: 1px solid #f0f0f0;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);

            color: #000; /* Chữ đen */
            font-weight: 700;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .btn-platinum:hover:not(:disabled) {
            /* Nâng cấp: Gradient sáng hơn */
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            transform: translateY(-2px); /* Tăng hiệu ứng hover */
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
        }
        .btn-platinum:disabled {
            background: var(--border-color); /* Quay về màu phẳng khi disable */
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: scale(1);
            border: 1px solid var(--border-color); /* Đồng bộ border */
            text-shadow: none; /* Tắt bóng chữ */
        }

        .bet-input {
            background-color: var(--dark-bg); /* Màu nền input */
            border: 1px solid var(--border-color);
            color: var(--yellow-primary);
            font-weight: 700;
            transition: all 0.2s;
        }
        .bet-input:focus {
            border-color: var(--yellow-primary);
            outline: none;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
        }
        
        /* Ô gạch */
        .game-tile {
            /* Nâng cấp: Gradient nổi khối 3D nhẹ */
            background: radial-gradient(circle, #383a42 0%, #2b2d35 80%);
            
            border: 1px solid var(--border-color);
            border-radius: 8px;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            
            /* Nâng cấp: transition mượt hơn */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* Nâng cấp: box-shadow */
            box-shadow: 0 4px 8px rgba(0,0,0,0.5), 
                        inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }
        .game-tile:disabled {
            background: #1a1b20; /* Nâng cấp: Dùng nền tối hơn khi vô hiệu hóa */
            border-color: #111;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }
        .game-tile:not(:disabled):hover {
            /* Nâng cấp: Thêm hiệu ứng nghiêng nhẹ khi hover */
            transform: scale(1.05) rotateZ(-2deg);
            border-color: var(--yellow-primary);
            /* Nâng cấp: Nền hover */
            background: radial-gradient(circle, #4a4d58 0%, #383a42 80%);
            box-shadow: 0 6px 12px rgba(0,0,0,0.6);
        }
        .game-tile i {
            /* Icon (Kim cương viền / Gem) */
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* [YÊU CẦU 1] Thêm hiệu ứng lấp lánh cho icon mặc định (fa-diamond) */
        .game-tile:not(.flipped-gem):not(.flipped-mine) i.fa-diamond {
             animation: pulse-default-icon 3s infinite ease-in-out;
        }

        .game-tile:not(:disabled):hover i {
            /* Icon khi hover */
            color: var(--yellow-primary);
            animation: none; /* [YÊU CẦU 1] Dừng lấp lánh khi hover */
        }
        
        /* [YÊU CẦU 1] Tắt animation mặc định khi lật */
        .game-tile.flipped-gem i,
        .game-tile.flipped-mine i {
            animation: none;
        }

        /* --- YÊU CẦU 3: NÂNG CẤP KIM CƯƠNG VÀNG --- */
        .game-tile.flipped-gem {
            /* Nâng cấp: Nền lấp lánh VÀNG */
            background: linear-gradient(
                110deg, 
                #1a1b20 20%, 
                #fde047 45%, /* Đổi sang màu vàng */
                #ffffff 50%,
                #fde047 55%, /* Đổi sang màu vàng */
                #1a1b20 80%
            );
            background-size: 200% 100%;
            animation: shimmer-bg 3s linear infinite; 
            
            /* Nâng cấp: Border và shadow VÀNG */
            border-color: var(--yellow-primary); 
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.7), /* Vàng */
                        0 0 10px rgba(255, 255, 255, 0.5) inset;
        }
        .game-tile.flipped-gem i {
            opacity: 1;
            color: var(--vip-gem); /* Icon vẫn là màu trắng nổi bật */
            
            /* Nâng cấp: text-shadow VÀNG */
            text-shadow: 0 0 20px rgba(255, 255, 255, 1), 
                         0 0 8px rgba(250, 204, 21, 0.8); /* Vàng */
            animation: pop 0.3s ease, pulse-gem 2s infinite 0.5s;
        }
        /* --- HẾT YÊU CẦU 3 --- */
        
        /* Mìn (Mine) - Giữ nguyên nâng cấp cũ */
        .game-tile.flipped-mine {
            /* Nâng cấp: Gradient đỏ "nóng chảy" */
            background: radial-gradient(ellipse at center, #501010 0%, #1a1b20 70%);
            border-color: var(--red-light);
            /* Nâng cấp: box-shadow */
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
            /* Nâng cấp: Chuyển animation 'shake' ra toàn bộ ô gạch */
            animation: shake 0.5s ease;
        }
        .game-tile.flipped-mine i {
            opacity: 1;
            color: var(--red-light);
            /* Nâng cấp: text-shadow và animation */
            text-shadow: 0 0 15px rgba(239, 68, 68, 1);
            animation: pulse-mine 1s infinite; /* Bỏ 'shake', thay bằng 'pulse' */
        }
        
        /* === KEYFRAMES === */

        /* Keyframes gốc (SHAKE) */
        @keyframes shake {
            0%, 100% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
        }

        /* --- YÊU CẦU 3: NÂNG CẤP KEYFRAME "POP" --- */
        @keyframes pop {
            0% { transform: scale(0.3) rotate(-45deg); opacity: 0; filter: blur(5px); }
            70% { transform: scale(1.2) rotate(10deg); opacity: 1; filter: blur(0px); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Keyframes nâng cấp (MỚI) */
        @keyframes shimmer-bg {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes pulse-gem {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }
        @keyframes pulse-mine {
            0%, 100% { transform: scale(1); opacity: 0.8;}
            50% { transform: scale(1.2); opacity: 1;}
        }

        /* [YÊU CẦU 1] Keyframe cho icon lấp lánh mặc định */
        @keyframes pulse-default-icon {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
                color: var(--text-secondary);
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
                color: var(--vip-gem); /* Lấp lánh màu trắng */
            }
        }

        /* === CSS CÒN LẠI (GIỮ NGUYÊN) === */

        .modal-overlay {
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .modal-card {
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            animation: modalPopIn 0.3s ease;
        }
        
        /* [THÊM] CSS Cho Modal Lịch Sử (giống reactor) */
        .modal-overlay-history {
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .loader-history { 
            border: 4px solid #f3f3f340; 
            border-top: 4px solid var(--yellow-primary); 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* --- Hết CSS Modal Lịch Sử --- */

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalPopIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .screen-shake { animation: screenShake 0.4s ease; }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        /* Confetti */
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        .confetti-piece { 
            position: absolute; width: 8px; height: 16px; 
            background-color: var(--yellow-primary); 
            opacity: 0.8; 
            animation: confettiFall 3s ease-out forwards; 
        }
        /* Thay đổi màu confetti để đồng bộ với theme VIP (Vàng, Trắng, Xanh Dương, Hồng, Tím) */
        .confetti-piece:nth-child(2) { background-color: var(--vip-gem); animation-delay: 0.1s; } 
        .confetti-piece:nth-child(3) { background-color: #3b82f6; animation-delay: 0.2s; }
        .confetti-piece:nth-child(4) { background-color: #ec4899; animation-delay: 0.3s; }
        .confetti-piece:nth-child(5) { background-color: #a855f7; animation-delay: 0.4s; }
        .confetti-piece:nth-child(6) { background-color: var(--yellow-primary); animation-delay: 0.5s; }
        .confetti-piece:nth-child(7) { background-color: var(--vip-gem); animation-delay: 0.6s; } 
        .confetti-piece:nth-child(8) { background-color: #3b82f6; animation-delay: 0.7s; }
        .confetti-piece:nth-child(9) { background-color: #ec4899; animation-delay: 0.8s; }
        .confetti-piece:nth-child(10) { background-color: #a855f7; animation-delay: 0.9s; }
        .confetti-piece:nth-child(11) { background-color: var(--yellow-primary); animation-delay: 1s; }
        .confetti-piece:nth-child(12) { background-color: var(--vip-gem); animation-delay: 1.1s; } 
        
        @keyframes confettiFall {
            from { top: -20px; transform: rotate(0deg) scale(1); }
            to { top: 100%; transform: rotate(720deg) scale(0.5); opacity: 0; }
        }
        
        /* [CẬP NHẬT] Điều chỉnh thanh điều khiển bên phải trên PC */
        .control-panel-desktop {
            position: fixed; /* Cố định vị trí */
            top: 2.5rem; /* [SỬA] Thay đổi từ top: 0; để tránh bị che */
            right: 0;
            bottom: 0;
            width: 24rem; /* 384px (lg:w-96) */
            padding: 1rem;
            overflow-y: auto; /* Cho phép cuộn nếu màn hình quá nhỏ */
            z-index: 20; /* Đảm bảo nằm trên main content */
            
            /* Sửa: Dùng chung style với .glass-panel */
        }

        @media (max-width: 1023px) {
            .control-panel-desktop {
                display: none;
            }
        }

        /* [CẬP NHẬT] Điều chỉnh khu vực game grid trên PC */
        @media (min-width: 1024px) {
            .main-game-area {
                margin-right: 24rem; /* Trừ đi độ rộng của control-panel-desktop */
            }
        }

        /* [THÊM LẠI] CSS cho thanh thông báo cuộn (Marquee) */
        .ticker-wrap {
            /* display: flex; align-items: center; -> Đã có trong class */
            white-space: nowrap; /* Ngăn ngắt dòng */
            will-change: transform;
            /* animation: ticker-scroll 30s linear infinite; -> Sẽ được set bằng JS */
        }
        .ticker-item {
            flex-shrink: 0;
            display: inline-flex; /* Rất quan trọng */
            align-items: center;
            padding: 0 1.5rem; /* Khoảng cách */
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* Luôn cuộn 50% */
        }

        /* [THÊM] Ẩn thanh cuộn cho modal lịch sử */
        #history-panel-container::-webkit-scrollbar {
            display: none;
        }
        #history-panel-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* [SỬA] XÓA BỎ PHẦN CSS THANH CUỘN TÙY CHỈNH CHO #main-content */
        /* (Đoạn mã CSS trước đó đã bị xóa) */

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="notification-ticker" class="absolute top-0 left-0 w-full h-10 z-30 hidden lg:flex items-center overflow-hidden" style="background-color: var(--dark-bg); border-bottom: 1px solid var(--border-color);">
        <div id="ticker-wrap-dynamic" class="ticker-wrap flex items-center">
            </div>
    </div>

    <div id="user-info-mobile" class="lg:hidden absolute top-0 left-0 w-full z-30 p-2 glass-panel transition-all duration-300" style="border-radius: 0; border-left: 0; border-right: 0;">
        <div class="flex flex-col sm:flex-row items-center justify-between w-full">
            <div class="flex flex-col sm:flex-row sm:items-center gap-x-3 gap-y-1 min-w-0 w-full sm:w-auto">
                <span id="user-vitals-mobile" class="text-xs sm:text-sm text-white font-semibold truncate">Xin chào, ...</span>
                <div class="flex items-baseline gap-1.5">
                    <span class="text-xs text-gray-400">Số dư:</span>
                    <span id="balance-mobile" class="font-bold text-sm sm:text-base truncate" style="color: var(--yellow-accent);">0.00 ₫</span>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                <a href="http://coinwit.net/index.html" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-home mr-1"></i>
                    <span>TRANG CHỦ</span>
                </a>
                <button id="my-history-btn-mobile" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-history mr-1"></i>
                    <span>LỊCH SỬ CƯỢC</span>
                </button>
                <button id="currency-toggle-btn-mobile" class="btn-dark-toggle py-1 px-2 text-xs sm:text-sm w-1/4 sm:w-auto">
                    <i class="fas fa-exchange-alt mr-1"></i>
                    <span>Đổi (USDT)</span>
                </button>
                <a href="deposit" class="btn-yellow-primary py-1 px-2 text-xs sm:text-sm block text-center w-1/4 sm:w-auto">
                    <i class="fas fa-wallet mr-1"></i>
                    <span>NẠP TIỀN</span>
                </a>
            </div>
        </div>
    </div>
    <main id="main-content" class="flex-grow flex flex-col lg:flex-row">
        
        <div class="main-game-area flex-grow flex justify-center items-center p-4 lg:p-8">
            <div class="w-full max-w-md lg:max-w-lg">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Hệ số tiếp theo</p>
                        <p id="next-multiplier" class="text-lg font-bold text-white">--</p>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Thắng tiềm năng</p>
                        <p id="potential-payout" class="text-lg font-bold" style="color: var(--yellow-accent);">0.00</p>
                    </div>
                    
                    <div class="glass-panel p-3 text-center col-span-2 lg:hidden">
                        <p class="text-xs text-gray-400">Thời gian còn lại</p>
                        <p id="game-timer-display" class="text-lg font-bold" style="color: var(--yellow-accent);">05:00</p>
                    </div>
                </div>

                <div id="game-grid" class="grid grid-cols-5 gap-2">
                    </div>
                
            </div>
        </div>

        <div class="hidden lg:flex lg:flex-col glass-panel space-y-4 control-panel-desktop">
            
            <div class="glass-panel p-4 space-y-4">
                <p id="info-username-desktop" class="text-sm font-medium text-gray-300 truncate">Xin chào, ...</p>
                
                <p class="text-xl">
                    <span class="text-gray-300">Số dư: </span>
                    <span id="info-balance-desktop-amount" class="font-bold" style="color: var(--yellow-accent);">0.00 ₫</span>
                </p>
                
                <div class="flex flex-col gap-2">
                    <a href="http://coinwit.net/index.html" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fas fa-home mr-1"></i> TRANG CHỦ
                    </a>
                    <button id="my-history-btn-desktop" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> LỊCH SỬ CƯỢC
                    </button>
                    <button id="currency-toggle-btn-desktop" class="text-center py-2.5 rounded-lg btn-dark-toggle text-sm font-semibold">
                        <i class="fa-solid fa-right-left mr-1"></i> <span>ĐỔI (USDT)</span>
                    </button>
                    <a href="deposit" class="block text-center py-3 rounded-lg btn-yellow-primary text-sm">
                        <i class="fa-solid fa-wallet mr-1"></i> NẠP TIỀN
                    </a>
                </div>
                </div>
            
            <div class="glass-panel p-4 space-y-4 flex-grow flex flex-col">
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Hệ số tiếp theo</p>
                        <p id="next-multiplier-desktop" class="text-lg font-bold text-white">--</p>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <p class="text-xs text-gray-400">Thắng tiềm năng</p>
                        <p id="potential-payout-desktop" class="text-lg font-bold" style="color: var(--yellow-accent);">0.00</p>
                    </div>
                </div>

                <div>
                    <label for="bet-amount-desktop" class="text-sm font-medium text-gray-300 mb-2 block cursor-pointer">Số tiền</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--yellow-accent);">
                            <i class="fa-solid fa-dollar-sign"></i>
                        </span>
                        <input id="bet-amount-desktop" type="number" value="1" class="w-full bet-input rounded-lg py-2.5 pl-9 pr-16 font-bold">
                        <span id="bet-currency-label-desktop" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-semibold" style="color: var(--text-secondary);">
                            USDT
                        </span>
                    </div>
                    </div>

                <div class="glass-panel p-3 text-center">
                    <p class="text-xs text-gray-400">Thời gian còn lại</p>
                    <p id="game-timer-display-desktop" class="text-lg font-bold" style="color: var(--yellow-accent);">05:00</p>
                </div>
                
                <div class="glass-panel text-center p-3">
                    <p class="text-sm text-white">
                        <span class="font-bold text-yellow-400">5 Mìn</span> / 
                        <span class="font-bold text-yellow-400">20 Kim cương</span>
                    </p>
                </div>
                <button id="action-button-desktop" class="w-full py-3.5 rounded-lg text-lg btn-yellow-primary mt-auto">
                    Bắt đầu
                </button>
            </div>
        </div>
    </main>

    <footer class="lg:hidden w-full glass-panel p-4 flex-shrink-0" style="border-radius: 0.5rem 0.5rem 0 0; border-bottom: 0;">
        <div class="w-full max-w-md mx-auto">
            <div class="mb-3">
                <label for="bet-amount-mobile" class="text-xs text-gray-400 mb-1 block cursor-pointer">Số tiền</label>
                 <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--yellow-accent);">
                        <i class="fa-solid fa-dollar-sign"></i>
                    </span>
                    <input id="bet-amount-mobile" type="number" value="1" class="w-full bet-input rounded-lg py-2.5 pl-9 pr-16 text-white font-bold">
                    <span id="bet-currency-label-mobile" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-semibold" style="color: var(--text-secondary);">
                        USDT
                    </span>
                </div>
                </div>
            <button id="action-button-mobile" class="w-full py-3.5 rounded-lg text-lg btn-yellow-primary">
                Bắt đầu
            </button>
        </div>
    </footer>
    
    <div id="failure-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center">
            <i class="fa-solid fa-bomb text-5xl text-red-light mb-4"></i>
            <h2 id="failure-modal-title" class="text-2xl font-bold text-white mb-2">Bạn đã trúng mìn!</h2>
            <p id="failure-modal-message" class="text-gray-300 mb-6">Trúng mìn mất rồi! Chúc may mắn lần sau.</p>
            <button id="failure-modal-close" class="w-full py-2.5 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors">
                OK
            </button>
        </div>
    </div>
    
    <div id="success-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="confetti-container">
            <div class="confetti-piece" style="left: 10%; animation-delay: 0s;"></div>
            <div class="confetti-piece" style="left: 20%; animation-delay: 0.1s;"></div>
            <div class="confetti-piece" style="left: 30%; animation-delay: 0.2s;"></div>
            <div class="confetti-piece" style="left: 40%; animation-delay: 0.3s;"></div>
            <div class="confetti-piece" style="left: 50%; animation-delay: 0.4s;"></div>
            <div class="confetti-piece" style="left: 60%; animation-delay: 0.5s;"></div>
            <div class="confetti-piece" style="left: 70%; animation-delay: 0.6s;"></div>
            <div class="confetti-piece" style="left: 80%; animation-delay: 0.7s;"></div>
            <div class="confetti-piece" style="left: 90%; animation-delay: 0.8s;"></div>
            <div class="confetti-piece" style="left: 5%; animation-delay: 0.9s;"></div>
            <div class="confetti-piece" style="left: 25%; animation-delay: 1.0s;"></div>
            <div class="confetti-piece" style="left: 75%; animation-delay: 1.1s;"></div>
        </div>
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center relative">
            <i class="fa-solid fa-circle-check text-5xl text-white mb-4"></i>
            <h2 class="text-2xl font-bold text-white mb-2">Xuất sắc!</h2>
            <p id="success-modal-message" class="text-gray-300 mb-6">Bạn đã rút tiền thành công!</p>
            <button id="success-modal-close" class="w-full py-2.5 rounded-lg font-semibold btn-yellow-primary">
                Tuyệt vời
            </button>
        </div>
    </div>
    
    <div id="warning-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-card w-full max-w-sm rounded-lg p-6 text-center">
            <i class="fa-solid fa-triangle-exclamation text-5xl text-yellow-primary mb-4"></i>
            <h2 id="warning-modal-title" class="text-2xl font-bold text-white mb-2">Chưa thể rút!</h2> <p id="warning-modal-message" class="text-gray-300 mb-6">Bạn phải lật ít nhất 1 kim cương.</p>
            <button id="warning-modal-close" class="w-full py-2.5 rounded-lg font-semibold btn-yellow-primary">
                Đã hiểu
            </button>
        </div>
    </div>
    
    <div id="my-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay-history">
        <div class="absolute inset-0"></div>
        <div class="relative w-full max-w-lg rounded-lg shadow-xl flex flex-col modal-card" style="max-height: 80vh;">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border-color)]">
                <h3 class="text-lg font-bold text-white">Lịch sử cược của tôi (Dò Mìn)</h3>
                <button id="my-history-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="history-panel-container" class="overflow-y-auto p-4 space-y-2">
                <div id="history-loading" class="text-center text-gray-400">
                    <div class="loader-history inline-block"></div>
                    <span class="ml-2">Đang tải lịch sử...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        // Trạng thái game
        let uiState = 'IDLE';
        let currentGame = null;
        let userBalance = 0;
        const MINE_COUNT = 5;
        const TOTAL_TILES = 25;
        const GAME_DURATION_SECONDS = 300; 
        
        // [SỬA] Cược min 0.1
        const MIN_BET_USDT = 0.10;

        let gameTimerInterval = null;
        let gameTimerSeconds = GAME_DURATION_SECONDS;

        // Elements
        const gameGrid = document.getElementById('game-grid');
        const nextMultiplierEl = document.getElementById('next-multiplier');
        const potentialPayoutEl = document.getElementById('potential-payout');
        const gameTimerDisplay = document.getElementById('game-timer-display');
        
        const nextMultiplierDesktopEl = document.getElementById('next-multiplier-desktop');
        const potentialPayoutDesktopEl = document.getElementById('potential-payout-desktop');
        const gameTimerDisplayDesktop = document.getElementById('game-timer-display-desktop');

        const balanceHeaderEl = document.getElementById('user-balance-header');
        
        const userInfoMobileEl = document.getElementById('user-info-mobile'); 
        const mainContentEl = document.getElementById('main-content'); // Thêm element main content
        
        const infoUsernameMobile = document.getElementById('user-vitals-mobile');
        const infoBalanceMobile = document.getElementById('balance-mobile');
        
        const infoUsernameDesktop = document.getElementById('info-username-desktop');
        const infoBalanceDesktop = document.getElementById('info-balance-desktop-amount'); 
        
        const betAmountMobile = document.getElementById('bet-amount-mobile');
        const betAmountDesktop = document.getElementById('bet-amount-desktop');
        const actionButtonMobile = document.getElementById('action-button-mobile');
        const actionButtonDesktop = document.getElementById('action-button-desktop');

        const currencyToggleBtnMobile = document.getElementById('currency-toggle-btn-mobile');
        const currencyToggleBtnDesktop = document.getElementById('currency-toggle-btn-desktop');
        
        const failureModal = document.getElementById('failure-modal');
        const failureModalTitle = document.getElementById('failure-modal-title');
        const failureModalMessage = document.getElementById('failure-modal-message');
        const failureModalClose = document.getElementById('failure-modal-close');
        
        const successModal = document.getElementById('success-modal');
        const successModalMessage = document.getElementById('success-modal-message');
        const successModalClose = document.getElementById('success-modal-close');
        
        const warningModal = document.getElementById('warning-modal');
        const warningModalTitle = document.getElementById('warning-modal-title'); // SỬA: Thêm warning title
        const warningModalMessage = document.getElementById('warning-modal-message');
        const warningModalClose = document.getElementById('warning-modal-close');
        
        // [THÊM] Elements Lịch sử cược (Modal)
        const myHistoryBtnMobile = document.getElementById('my-history-btn-mobile');
        const myHistoryBtnDesktop = document.getElementById('my-history-btn-desktop');
        const myHistoryModal = document.getElementById('my-history-modal');
        const myHistoryCloseBtn = document.getElementById('my-history-close-btn');
        const historyPanelContainer = document.getElementById('history-panel-container');
        const historyLoading = document.getElementById('history-loading');


        // (Các hàm tính toán giữ nguyên)
        const HOUSE_EDGE = 0.05;
        function nCr(n, k) {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            if (k > n / 2) k = n - k;
            let res = 1;
            for (let i = 1; i <= k; ++i) {
                res = res * (n - i + 1) / i;
            }
            return Math.floor(res);
        }
        function calculateMultiplier(gemsPicked, mineCount) {
            const gemCount = TOTAL_TILES - mineCount;
            if (gemsPicked > gemCount) return 0;
            const totalCombinations = nCr(TOTAL_TILES, gemsPicked);
            const gemCombinations = nCr(gemCount, gemsPicked);
            if (gemCombinations === 0) return 0;
            const fairMultiplier = totalCombinations / gemCombinations;
            let finalMultiplier = fairMultiplier * (1 - HOUSE_EDGE);
            // Giảm thêm 5% hệ số ở lần mở ô thứ 3 theo yêu cầu
            if (gemsPicked === 3) {
                finalMultiplier = finalMultiplier * 0.95;
            }
            return parseFloat(finalMultiplier.toFixed(2));
        }


        // --- Khởi tạo ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Kiểm tra và khởi tạo các hàm toàn cục (formatCurrency, initCurrency, checkLogin, fetchAPI)
            if (typeof initCurrency === 'undefined' || typeof checkLogin === 'undefined') {
                // Fallback nếu không có main.js
                window.globalCurrency = 'USDT';
                window.globalExchangeRate = 25000;
                window.formatCurrency = (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
                // Giả định checkLogin luôn thành công cho mục đích hiển thị
                window.checkLogin = () => true;
            } else {
                await initCurrency(); 
                if (!checkLogin(true)) return;
            }

            try {
                // Giả định fetchAPI đã được định nghĩa trong main.js
                const data = typeof fetchAPI !== 'undefined' ? await fetchAPI('/user/profile') : { username: 'Khách', balance: 1000.00 };
                userBalance = data.balance;
                if(infoUsernameMobile) infoUsernameMobile.textContent = `Xin chào, ${data.username}`; // [THÊM LẠI]
                if(infoUsernameDesktop) infoUsernameDesktop.textContent = `Xin chào, ${data.username}`;
                updateBalanceDisplay(); 
                updateCurrencyToggleText(); 
                updateBetCurrencyLabel(); // [YÊU CẦU 2] Cập nhật nhãn tiền cược
            } catch (error) {
            }
            
            createGrid();
            setupEventListeners();
            
            // [THÊM MỚI] Kiểm tra ván game đang hoạt động
            // Hàm này sẽ tự động chuyển uiState sang 'BETTING' nếu cần
            await checkActiveGame(); 
            
            // [SỬA] Chỉ cập nhật IDLE nếu không có game nào đang chạy
            if (uiState !== 'BETTING') {
                updateUIState('IDLE');
            }

            // [SỬA] Đặt giá trị mặc định là 1 USDT
            setBetAmount(1.00); 
            
            // [THÊM] Khởi động ticker
            setupDynamicTicker();
        });

        // [THÊM MỚI] Hàm kiểm tra và khôi phục game
        async function checkActiveGame() {
            if (typeof fetchAPI === 'undefined') return;

            try {
                const data = await fetchAPI('/game/mines/check-active');
                
                if (data.active) {
                    
                    // Khôi phục đối tượng game
                    currentGame = {
                        sessionId: data.sessionId,
                        betAmount: data.betAmount,
                        mineCount: data.mineCount,
                        tilesRevealed: data.tilesRevealed,
                        currentMultiplier: data.currentMultiplier
                    };
                    
                    // Khôi phục bộ đếm thời gian
                    const timeElapsed = Math.floor((Date.now() - data.startTime) / 1000);
                    const timeRemaining = GAME_DURATION_SECONDS - timeElapsed;
                    
                    if (timeRemaining <= 0) {
                        // Mặc dù server có check, client cũng check
                        handleGameTimeout([]); 
                        return;
                    }
                    
                    gameTimerSeconds = timeRemaining;
                    stopGameTimer(); // Dừng timer cũ (nếu có)
                    gameTimerInterval = setInterval(updateGameTimer, 1000); // Khởi động lại
                    
                    // Khôi phục các ô đã lật
                    data.tilesRevealed.forEach(index => {
                        const tile = gameGrid.querySelector(`[data-index="${index}"]`);
                        if (tile) {
                            tile.classList.add('flipped-gem');
                            // [YÊU CẦU 1] ĐỔI ICON KHI KHÔI PHỤC GAME (GEM)
                            tile.innerHTML = `<i class="fa-solid fa-gem"></i>`; // Đổi thành gem để khớp
                            tile.disabled = true;
                        }
                    });

                    // Cập nhật trạng thái
                    updateUIState('BETTING');
                }
            } catch (error) {
                // Nếu lỗi, cứ để trạng thái IDLE
            }
        }

        function createGrid() {
            gameGrid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const tile = document.createElement('button');
                tile.className = 'game-tile';
                tile.dataset.index = i;
                tile.disabled = true;
                // [YÊU CẦU 1] ĐỔI ICON TỪ CUBE THÀNH DIAMOND (viền)
                tile.innerHTML = `<i class="fa-solid fa-diamond"></i>`;
                gameGrid.appendChild(tile);
            }
        }
        
        function updateBalanceDisplay() {
            // Lấy hàm formatCurrency toàn cục
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            
            const formattedBalance = formatter(userBalance);
            if(balanceHeaderEl) balanceHeaderEl.textContent = formattedBalance; 
            if(infoBalanceMobile) infoBalanceMobile.textContent = formattedBalance; // [THÊM LẠI]
            if(infoBalanceDesktop) infoBalanceDesktop.textContent = formattedBalance;
        }

        function updateCurrencyToggleText() {
            const currentCurrency = window.globalCurrency || 'USDT';
            const text = (currentCurrency === 'USDT' ? 'Đổi (VND)' : 'Đổi (USDT)');
            if (currencyToggleBtnMobile) currencyToggleBtnMobile.querySelector('span').textContent = text; // [THÊM LẠI]
            if (currencyToggleBtnDesktop) currencyToggleBtnDesktop.querySelector('span').textContent = text;
        }

        // [YÊU CẦU 2] Hàm mới: Cập nhật nhãn tiền tệ trên ô nhập tiền
        function updateBetCurrencyLabel() {
            const currentCurrency = window.globalCurrency || 'USDT';
            const labelDesktop = document.getElementById('bet-currency-label-desktop');
            const labelMobile = document.getElementById('bet-currency-label-mobile');
            
            // Hiển thị "vnđ" hoặc "USDT"
            const currencyText = (currentCurrency === 'VND') ? 'vnđ' : 'USDT';
            
            if (labelDesktop) labelDesktop.textContent = currencyText;
            if (labelMobile) labelMobile.textContent = currencyText;
        }

        async function toggleCurrency() {
            if (typeof initCurrency === 'undefined') {
                return;
            }
            const currentCurrency = window.globalCurrency || 'USDT';
            const newCurrency = (currentCurrency === 'USDT') ? 'VND' : 'USDT';
            localStorage.setItem('selectedCurrency', newCurrency);
            await initCurrency(); 
            
            updateBalanceDisplay(); 
            updateCurrencyToggleText(); 
            updateBetCurrencyLabel(); // [YÊU CẦU 2] Cập nhật nhãn tiền cược
            
            // Giữ nguyên số tiền cược (USDT) sau khi đổi đơn vị hiển thị
            const currentBetUSDT = parseFloat(betAmountDesktop.dataset.amountUsdt || betAmountMobile.dataset.amountUsdt || 1);
            setBetAmount(currentBetUSDT);
        }

        function setBetAmount(amountUSDT) {
            const numAmount = parseFloat(amountUSDT);
            if (isNaN(numAmount) || typeof formatCurrency === 'undefined') return;
            
            // [SỬA] Cập nhật dataset
            betAmountMobile.dataset.amountUsdt = numAmount.toFixed(4);
            betAmountDesktop.dataset.amountUsdt = numAmount.toFixed(4);

            const currentCurrency = window.globalCurrency || 'USDT';
            const exchangeRate = window.globalExchangeRate || 25000;

            if (currentCurrency === 'VND') {
                // Đảm bảo số tiền VND không nhỏ hơn 1000 và làm tròn đến nghìn
                const minVND = Math.ceil(MIN_BET_USDT * exchangeRate / 1000) * 1000;
                const amountVND = Math.max(minVND, Math.floor(numAmount * exchangeRate / 1000) * 1000); 
                betAmountMobile.value = amountVND;
                betAmountDesktop.value = amountVND;
            } else {
                // [SỬA] Xử lý "1" vs "1.00"
                const amountUSDT_Display = Math.max(MIN_BET_USDT, numAmount);
                
                // Nếu giá trị là 1 (mặc định), hiển thị "1".
                if (amountUSDT_Display === 1) {
                        betAmountMobile.value = "1";
                        betAmountDesktop.value = "1";
                } else {
                        // Làm tròn 2 chữ số cho các số khác 1 (ví dụ 1.50)
                        betAmountMobile.value = amountUSDT_Display.toFixed(2);
                        betAmountDesktop.value = amountUSDT_Display.toFixed(2);
                }
            }
        }
        
        function syncBetDataset(sourceInput) {
            let val = parseFloat(sourceInput.value);
            
            // Nếu người dùng xóa trống, giá trị là NaN.
            // Chúng ta muốn lưu trữ 0 trong dataset để getBetAmount xử lý.
            if (isNaN(val)) {
                val = 0;
            }

            const currentCurrency = window.globalCurrency || 'USDT';
            const exchangeRate = window.globalExchangeRate || 25000;

            let amountUSDT;
            if (currentCurrency === 'VND') {
                amountUSDT = val / exchangeRate;
            } else {
                amountUSDT = val;
            }

            betAmountMobile.dataset.amountUsdt = amountUSDT.toFixed(4);
            betAmountDesktop.dataset.amountUsdt = amountUSDT.toFixed(4);
            
            // Đồng bộ giá trị gõ sang input còn lại
            const otherInput = sourceInput.id === 'bet-amount-mobile' ? betAmountDesktop : betAmountMobile;
            otherInput.value = sourceInput.value;
        }

        function getBetAmount() {
            // Đọc giá trị USDT đã được đồng bộ hóa từ dataset
            // Nếu dataset rỗng, || 0 sẽ bắt
            const amountUSDT = parseFloat(betAmountDesktop.dataset.amountUsdt || 0);
            
            if (amountUSDT < MIN_BET_USDT) {
                // Nếu giá trị trong dataset (từ input) < 0.1, tự động set lại hiển thị là 0.1
                setBetAmount(MIN_BET_USDT); 
                return MIN_BET_USDT; // Và bắt đầu game với 0.1
            }
            
            return amountUSDT;
        }


        
        // --- Cập nhật Giao diện ---
        function updateUIState(newState) {
            uiState = newState;
            
            // Lấy hàm formatCurrency toàn cục
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';

            
            // [CẬP NHẬT] Điều chỉnh padding-top cho thanh ticker mới
            if (window.innerWidth < 1024) {
                // MOBILE LOGIC
                if (uiState === 'IDLE') {
                    if (userInfoMobileEl) userInfoMobileEl.style.display = 'block';
                    mainContentEl.querySelector('.main-game-area').style.paddingTop = '75px'; 
                } else if (uiState === 'BETTING') {
                    if (userInfoMobileEl) userInfoMobileEl.style.display = 'none';
                    mainContentEl.querySelector('.main-game-area').style.paddingTop = '16px'; 
                }
            } else {
                // DESKTOP LOGIC
                // [SỬA LỖI] Luôn ẩn thanh thông tin di động trên desktop
                if (userInfoMobileEl) userInfoMobileEl.style.display = 'none';
                
                // Desktop: 40px (ticker) + 32px (lg:p-8) = 72px
                mainContentEl.querySelector('.main-game-area').style.paddingTop = '72px';
            }


            if (uiState === 'IDLE') {
                actionButtonMobile.textContent = 'Bắt đầu';
                actionButtonDesktop.textContent = 'Bắt đầu';
                actionButtonMobile.classList.remove('btn-platinum'); 
                actionButtonDesktop.classList.remove('btn-platinum'); 
                actionButtonMobile.classList.add('btn-yellow-primary');
                actionButtonDesktop.classList.add('btn-yellow-primary');
                actionButtonMobile.disabled = false;
                actionButtonDesktop.disabled = false;
                
                betAmountMobile.disabled = false;
                betAmountDesktop.disabled = false;
                
                gameGrid.querySelectorAll('.game-tile').forEach(tile => {
                    tile.disabled = true;
                    tile.classList.remove('flipped-gem', 'flipped-mine');
                    // [YÊU CẦU 1] ĐỔI ICON TỪ CUBE THÀNH DIAMOND (viền)
                    tile.innerHTML = `<i class="fa-solid fa-diamond"></i>`;
                });
                
                nextMultiplierEl.textContent = '--';
                potentialPayoutEl.textContent = '0.00';
                if(nextMultiplierDesktopEl) nextMultiplierDesktopEl.textContent = '--';
                if(potentialPayoutDesktopEl) potentialPayoutDesktopEl.textContent = '0.00';
                
                const formattedStartTime = formatTime(GAME_DURATION_SECONDS);
                if(gameTimerDisplay) gameTimerDisplay.textContent = formattedStartTime;
                if(gameTimerDisplayDesktop) gameTimerDisplayDesktop.textContent = formattedStartTime;
                
                if(gameTimerDisplay) {
                    gameTimerDisplay.classList.remove('text-red-500');
                    gameTimerDisplay.style.color = 'var(--yellow-accent)';
                }
                if(gameTimerDisplayDesktop) {
                    gameTimerDisplayDesktop.classList.remove('text-red-500');
                    gameTimerDisplayDesktop.style.color = 'var(--yellow-accent)';
                }
                
            } else if (uiState === 'BETTING') {
                const btnText = `Rút tiền (x${currentGame.currentMultiplier.toFixed(2)})`;
                actionButtonMobile.textContent = btnText;
                actionButtonDesktop.textContent = btnText;
                actionButtonMobile.classList.remove('btn-yellow-primary');
                actionButtonDesktop.classList.remove('btn-yellow-primary');
                actionButtonMobile.classList.add('btn-platinum'); 
                actionButtonDesktop.classList.add('btn-platinum'); 
                actionButtonMobile.disabled = false;
                actionButtonDesktop.disabled = false;
                
                betAmountMobile.disabled = true;
                betAmountDesktop.disabled = true;
                
                gameGrid.querySelectorAll('.game-tile').forEach(tile => {
                    const tileIndex = parseInt(tile.dataset.index);
                    if (!currentGame.tilesRevealed.includes(tileIndex)) {
                           tile.disabled = false;
                    }
                });
                
                const nextGemCount = currentGame.tilesRevealed.length + 1;
                const nextMulti = calculateMultiplier(nextGemCount, currentGame.mineCount);
                const potentialPayout = currentGame.betAmount * currentGame.currentMultiplier; 

                nextMultiplierEl.textContent = `x${nextMulti.toFixed(2)}`;
                potentialPayoutEl.textContent = formatter(potentialPayout); 
                if(nextMultiplierDesktopEl) nextMultiplierDesktopEl.textContent = `x${nextMulti.toFixed(2)}`;
                if(potentialPayoutDesktopEl) potentialPayoutDesktopEl.textContent = formatter(potentialPayout); 
                
                // Cập nhật lại nút Rút tiền với số tiền rút ra
                const cashoutAmount = currentGame.betAmount * currentGame.currentMultiplier;
                  actionButtonMobile.textContent = `Rút tiền (${formatter(cashoutAmount)})`;
                  actionButtonDesktop.textContent = `Rút tiền (${formatter(cashoutAmount)})`;
            }
        }
        
        // --- Xử lý sự kiện resize để cập nhật UI mobile/desktop ---
        window.addEventListener('resize', () => {
            updateUIState(uiState); 
        });

        // --- Logic Modal & Timer ---
        function showFailureModal(title, message) {
            document.body.classList.add('screen-shake');
            failureModalTitle.textContent = title;
            failureModalMessage.textContent = message;
            failureModal.classList.remove('hidden');
        }

        function showSuccessModal(profit) {
            // Lấy hàm formatCurrency toàn cục
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            
            successModalMessage.textContent = `Bạn đã rút tiền thành công: +${formatter(profit)}!`;
            successModal.classList.remove('hidden');
        }
        
        function showWarningModal(message, title = "Chưa thể rút!") { // SỬA: Thêm title
            warningModalTitle.textContent = title;
            warningModalMessage.textContent = message;
            warningModal.classList.remove('hidden');
        }

        function hideModals() {
            document.body.classList.remove('screen-shake');
            failureModal.classList.add('hidden');
            successModal.classList.add('hidden');
            warningModal.classList.add('hidden');
        }
        
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function stopGameTimer() {
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        function startGameTimer() {
            stopGameTimer(); 
            gameTimerSeconds = GAME_DURATION_SECONDS;
            
            const formattedTime = formatTime(gameTimerSeconds);
            if(gameTimerDisplay) gameTimerDisplay.textContent = formattedTime;
            if(gameTimerDisplayDesktop) gameTimerDisplayDesktop.textContent = formattedTime;
            
            gameTimerInterval = setInterval(updateGameTimer, 1000);
        }
        
        function updateGameTimer() {
            gameTimerSeconds--;
            
            const formattedTime = formatTime(gameTimerSeconds);
            if(gameTimerDisplay) gameTimerDisplay.textContent = formattedTime;
            if(gameTimerDisplayDesktop) gameTimerDisplayDesktop.textContent = formattedTime;
            
            if (gameTimerSeconds <= 10) {
                if(gameTimerDisplay) {
                    gameTimerDisplay.style.color = 'var(--red-light)';
                }
                if(gameTimerDisplayDesktop) {
                    gameTimerDisplayDesktop.style.color = 'var(--red-light)';
                }
            }
            
            if (gameTimerSeconds <= 0) {
                handleGameTimeout([]); 
            }
        }
        
        function handleGameTimeout(allMines = []) {
            stopGameTimer();
            if (allMines.length > 0) {
                 allMines.forEach(index => {
                    const mineTile = gameGrid.querySelector(`[data-index="${index}"]`);
                    if (mineTile) {
                        mineTile.classList.add('flipped-mine');
                        mineTile.innerHTML = `<i class="fa-solid fa-bomb"></i>`;
                    }
                });
            }
            gameGrid.querySelectorAll('.game-tile').forEach(t => t.disabled = true);
            actionButtonMobile.disabled = true;
            actionButtonDesktop.disabled = true;
            
            showFailureModal("Đã hết thời gian!", "Mìn đã nổ! Ván cược của bạn đã bị hủy.");
            // Cập nhật lại trạng thái IDLE sau khi hiển thị modal
        }

        // --- Logic Game ---
        async function handleActionClick() {
            if (uiState === 'IDLE') {
                await startGame();
            } else if (uiState === 'BETTING') {
                await cashOut();
            }
        }
        
        async function startGame() {
            // Giả định fetchAPI được định nghĩa
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }

            const betAmount = getBetAmount(); 
            // [SỬA] Cược tối thiểu 0.1
            if (isNaN(betAmount) || betAmount < MIN_BET_USDT) { 
                const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
                showWarningModal(`Số tiền cược tối thiểu là ${formatter(MIN_BET_USDT)}.`, "Số tiền không hợp lệ");
                return;
            }
            if (betAmount > userBalance) {
                showWarningModal("Số dư không đủ.", "Lỗi số dư");
                return;
            }
            
            actionButtonMobile.disabled = true;
            actionButtonDesktop.disabled = true;
            actionButtonDesktop.textContent = 'Đang bắt đầu...';
            actionButtonMobile.textContent = 'Đang bắt đầu...';

            try {
                // [SỬA] Gửi userBalance lên server để tính toán logic "bịp"
                const data = await fetchAPI('/game/mines/start', {
                    method: 'POST',
                    body: JSON.stringify({
                        betAmount: betAmount,
                        mineCount: MINE_COUNT,
                        userTotalBalance: userBalance // Gửi tổng số dư
                    })
                });
                
                userBalance = data.newBalance;
                updateBalanceDisplay();
                
                currentGame = {
                    sessionId: data.sessionId,
                    betAmount: betAmount,
                    mineCount: MINE_COUNT,
                    tilesRevealed: [],
                    currentMultiplier: 1.00 // Đặt lại về 1.00 sau khi trừ tiền
                };
                
                startGameTimer(); 
                updateUIState('BETTING');
                
            } catch (error) {
                // [SỬA] Hiển thị lỗi từ server (ví dụ: "Bạn đang có một ván Dò mìn đang chạy...")
                showWarningModal(`${error.message}`, "Lỗi Hệ Thống"); 
                updateUIState('IDLE');
            }
        }

        async function handleTileClick(e) {
            // Giả định fetchAPI được định nghĩa
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }

            const tile = e.target.closest('.game-tile');
            if (!tile || uiState !== 'BETTING' || tile.disabled) return;
            
            const tileIndex = parseInt(tile.dataset.index);
            if (currentGame.tilesRevealed.includes(tileIndex)) return;
            
            tile.disabled = true; 

            try {
                const data = await fetchAPI('/game/mines/reveal', {
                    method: 'POST',
                    body: JSON.stringify({
                        sessionId: currentGame.sessionId,
                        tileIndex: tileIndex
                    })
                });
                
                if (data.isMine) {
                    stopGameTimer();
                    tile.classList.add('flipped-mine');
                    tile.innerHTML = `<i class="fa-solid fa-bomb"></i>`;
                    userBalance = data.newBalance;
                    updateBalanceDisplay();
                    
                    data.allMines.forEach(index => {
                        const mineTile = gameGrid.querySelector(`[data-index="${index}"]`);
                        if (mineTile) {
                            mineTile.classList.add('flipped-mine');
                            mineTile.innerHTML = `<i class="fa-solid fa-bomb"></i>`;
                        }
                    });

                    gameGrid.querySelectorAll('.game-tile').forEach(t => t.disabled = true);
                    actionButtonMobile.disabled = true;
                    actionButtonDesktop.disabled = true;

                    setTimeout(() => showFailureModal("Bạn đã trúng mìn!", "Trúng mìn mất rồi! Chúc may mắn lần sau."), 500);
                    
                } else {
                    tile.classList.add('flipped-gem');
                    // [YÊU CẦU 1] ĐỔI ICON KHI LẬT TRÚNG (GEM)
                    tile.innerHTML = `<i class="fa-solid fa-gem"></i>`; // Đổi thành icon Gem (full)
                    currentGame.tilesRevealed.push(tileIndex);
                    currentGame.currentMultiplier = data.newMultiplier;
                    updateUIState('BETTING'); 
                }
                
            } catch (error) {
                if (error.isTimeout) {
                    handleGameTimeout(error.allMines || []);
                } else {
                    showFailureModal("Lỗi Hệ Thống", `Lật ô thất bại: ${error.message}`);
                    tile.disabled = false;
                }
            }
        }
        
        async function cashOut() {
            // Giả định fetchAPI được định nghĩa
            if (typeof fetchAPI === 'undefined') {
                showWarningModal("Chức năng cược chưa khả dụng.");
                return;
            }

            if (currentGame.tilesRevealed.length === 0) {
                 showWarningModal('Bạn phải lật ít nhất 1 kim cương để rút tiền.', 'Chưa thể rút!');
                 return;
            }
            
            actionButtonMobile.disabled = true;
            actionButtonDesktop.disabled = true;
            actionButtonMobile.textContent = 'Đang rút tiền...';
            actionButtonDesktop.textContent = 'Đang rút tiền...';
            
            try {
                const data = await fetchAPI('/game/mines/cashout', {
                    method: 'POST',
                    body: JSON.stringify({
                        sessionId: currentGame.sessionId
                    })
                });
                
                stopGameTimer();
                userBalance = data.newBalance;
                updateBalanceDisplay();
                showSuccessModal(data.profit);
                
            } catch (error) {
                if (error.isTimeout) {
                    handleGameTimeout(error.allMines || []);
                } else {
                    showFailureModal("Lỗi Hệ Thống", `Rút tiền thất bại: ${error.message}`);
                    updateUIState('BETTING');
                }
            }
        }
        
        // --- Gán sự kiện ---
        function setupEventListeners() {
            actionButtonMobile.addEventListener('click', handleActionClick);
            actionButtonDesktop.addEventListener('click', handleActionClick);
            
            gameGrid.addEventListener('click', handleTileClick);
            
            betAmountMobile.addEventListener('input', (e) => {
                syncBetDataset(e.target);
            });
            betAmountDesktop.addEventListener('input', (e) => {
                syncBetDataset(e.target);
            });
            
            failureModalClose.addEventListener('click', () => {
                hideModals();
                updateUIState('IDLE');
            });
            successModalClose.addEventListener('click', () => {
                hideModals();
                updateUIState('IDLE');
            });
            warningModalClose.addEventListener('click', () => {
                hideModals();
            });

            if (currencyToggleBtnMobile) { // [THÊM LẠI]
                currencyToggleBtnMobile.addEventListener('click', toggleCurrency);
            }
            if (currencyToggleBtnDesktop) {
                currencyToggleBtnDesktop.addEventListener('click', toggleCurrency);
            }
            
            // [THÊM] Sự kiện Lịch sử cược (Modal)
            if (myHistoryBtnMobile) {
                myHistoryBtnMobile.addEventListener('click', () => {
                    myHistoryModal.classList.remove('hidden');
                    loadBetHistory(); 
                });
            }
            if (myHistoryBtnDesktop) {
                myHistoryBtnDesktop.addEventListener('click', () => {
                    myHistoryModal.classList.remove('hidden');
                    loadBetHistory(); 
                });
            }
            if (myHistoryCloseBtn) {
                myHistoryCloseBtn.addEventListener('click', () => {
                    myHistoryModal.classList.add('hidden');
                });
            }

            // Cập nhật lại UI sau khi resize
            window.addEventListener('resize', () => {
                // Đảm bảo padding-top được tính lại khi chuyển đổi mobile/desktop
                updateUIState(uiState); 
            });
        }
        
        
        // [SỬA] LOGIC CHO THANH THÔNG BÁO ĐỘNG (MARQUEE)
        // ----------------------------------------------------
        let winNotificationQueue = []; // Hàng đợi (Real wins + Bot wins)
        
        // [SỬA] Danh sách tin nhắn khuyến mãi (Thêm 3 tin)
        const promoMessages = [
            `🎉 Mời bạn bè chơi nhận ngay hoa hồng!`,
            `💰 Nạp tiền lần đầu nhận ngay thưởng chào mừng!`,
            `🚀 Tham gia nhóm Telegram để nhận khuyến mãi!`,
            `💎 Lên VIP để nhận thưởng thăng cấp và nhận các ưu đãi!`
        ];
        let promoMessageIndex = 0;
        
        let currentTickerItems = []; // Danh sách 7 mục đang hiển thị
        const MAX_TICKER_ITEMS = 7; // Hiển thị tối đa 7 tin nhắn

        function setupDynamicTicker() {
            // 1. Kết nối Socket.IO
            const socket = io(window.API_BASE_URL || 'http://coinwit.net', {
                query: {
                    user_id: localStorage.getItem('authToken') ? jwt_decode(localStorage.getItem('authToken')).userId : null
                }
            });

            // 2. Lắng nghe tin thắng thật -> Thêm vào hàng đợi
            socket.on('new_win_notification', (data) => {
                winNotificationQueue.push(data);
            });
            
            // 3. Hẹn giờ tạo bot -> Thêm vào hàng đợi
            setInterval(createBotWin, 15000); // 15 giây tạo 1 bot
            
            // 4. [SỬA] Khởi tạo, lấp đầy 7 mục ban đầu bằng tin KM
            for(let i = 0; i < MAX_TICKER_ITEMS; i++) {
                currentTickerItems.push(createPromoHTML());
            }
            renderTickerHTML(); // Render lần đầu
            
            // 5. [SỬA] Bắt đầu vòng lặp cập nhật chính (5 giây 1 lần)
            setInterval(updateTickerList, 5000); 
        }

        // Hàm tạo HTML cho tin thắng (Real hoặc Bot)
        function createWinHTML(winData) {
            const formatter = typeof formatCurrency !== 'undefined' ? formatCurrency : (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' USDT';
            const formattedAmount = formatter(winData.amount);
            const username = winData.username.substring(0, 4) + '***';

            return `
                <span class="ticker-item">
                    <i class="fa-solid fa-star text-yellow-400 mr-2 text-xs"></i>
                    <span class="text-white font-medium text-sm">${username}</span>
                    <span class="text-gray-400 mx-1 text-sm">vừa thắng</span>
                    <span class="text-yellow-400 font-bold text-sm">${formattedAmount}</span>
                </span>
            `;
        }

        // Hàm tạo HTML cho tin khuyến mãi (xoay vòng)
        function createPromoHTML() {
            const promoHTML = `
                <span class="ticker-item">
                    <i class="fa-solid fa-gift text-cyan-400 mr-2 text-xs"></i>
                    <span class="text-white font-medium text-sm">${promoMessages[promoMessageIndex]}</span>
                </span>
            `;
            promoMessageIndex = (promoMessageIndex + 1) % promoMessages.length;
            return promoHTML;
        }

        // Hàm tạo một tin thắng của BOT (đẩy vào hàng đợi)
        function createBotWin() {
            const botUser = `Player***${Math.floor(Math.random() * 900) + 100}`;
            const botAmount = (Math.random() * 50 + 10).toFixed(2);
            
            winNotificationQueue.push({
                username: botUser,
                amount: botAmount,
                currency: 'USDT'
            });
        }
        
        // [SỬA] Hàm cập nhật danh sách (5 giây/lần)
        function updateTickerList() {
            let newItemHTML = '';

            // Ưu tiên 1: Lấy tin thắng (Thật hoặc Bot)
            if (winNotificationQueue.length > 0) {
                const winData = winNotificationQueue.shift(); // Lấy tin thắng
                newItemHTML = createWinHTML(winData);
            } 
            // Ưu tiên 2: Nếu không có tin thắng, lấy tin KM
            else {
                newItemHTML = createPromoHTML();
            }
            
            // Thêm tin mới vào cuối
            currentTickerItems.push(newItemHTML);
            
            // Xóa tin cũ nhất (để giữ danh sách = 7)
            while (currentTickerItems.length > MAX_TICKER_ITEMS) {
                currentTickerItems.shift(); 
            }
            
            // Render lại HTML
            renderTickerHTML();
        }
        
        // Hàm render HTML và áp dụng animation
        function renderTickerHTML() {
            const wrap = document.getElementById('ticker-wrap-dynamic');
            if (!wrap) return;

            // [SỬA] Chỉ join 7 mục
            const itemsHTML = currentTickerItems.join('');
            
            // Nhân đôi nội dung để cuộn mượt
            wrap.innerHTML = itemsHTML + itemsHTML;
            
            // Tính toán lại tốc độ cuộn
            wrap.style.animation = 'none';
            void wrap.offsetWidth; // Trigger reflow
            
            const contentWidth = wrap.scrollWidth / 2;
            const duration = contentWidth / 60; // Tốc độ: 60 pixels / giây

            if (duration > 0) {
                 wrap.style.animation = `ticker-scroll ${duration.toFixed(2)}s linear infinite`;
            }
        }
        
        // Hàm giải mã JWT (giữ nguyên)
        function jwt_decode(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }
        
        // [THÊM] CÁC HÀM LỊCH SỬ CƯỢC (TỪ REACTOR)
        // ----------------------------------------------------

        async function loadBetHistory() {
            historyPanelContainer.innerHTML = ''; 
            historyLoading.classList.remove('hidden');
            historyPanelContainer.appendChild(historyLoading);
            
            if (typeof window.fetchAPI !== 'function') {
                historyPanelContainer.innerHTML = '<p class="text-center text-red-400">Lỗi: Không tìm thấy hàm fetchAPI.</p>'; 
                return;
            }
            try {
                // 1. GỌI API
                const historyData = await fetchAPI('/api/game/bet-history');
                
                // 2. IN RA DỮ LIỆU THÔ (Để debug)
                
                historyLoading.classList.add('hidden'); 
                historyPanelContainer.innerHTML = '';
                
                // 3. LỌC GAME 'MINES'
                // [SỬA LỖI] Dùng .startsWith() để khớp với "MINES (5 mìn)"
                const minesHistory = historyData.filter(bet => bet.betType && bet.betType.startsWith('MINES'));
                
                // 4. IN RA DỮ LIỆU SAU KHI LỌC (Để debug)

                if (minesHistory.length === 0) {
                    // Nếu historyData là [], hoặc không có betType nào là 'MINES',
                    // nó sẽ hiển thị thông báo này.
                    historyPanelContainer.innerHTML = '<p class="text-center text-gray-400">Bạn chưa có lịch sử cược nào cho game này.</p>'; 
                    return;
                }
                
                // [SỬA LỖI] Xóa .reverse() vì API đã trả về đúng thứ tự (mới nhất ở trên)
                minesHistory.forEach(bet => { 
                    historyPanelContainer.appendChild(createHistoryRow(bet)); 
                });
                
            } catch (error) { 
                historyPanelContainer.innerHTML = `<p class="text-center text-red-400">Lỗi: ${error.message}</p>`; 
            }
        }
        
        function createHistoryRow(bet) {
            const row = document.createElement('div');
            // [SỬA] Dùng CSS var của Mines
            row.className = 'bg-[var(--dark-bg)] p-3 rounded-lg flex items-center gap-3 border border-[var(--border-color)]';
            
            let statusColorClass = 'text-gray-400';
            let payoutText = '...';
            let payoutColorClass = 'text-white';
            let iconClass = 'fa-clock';
            
            if (bet.status === 'WIN') {
                statusColorClass = 'text-green-400'; 
                payoutText = `+${bet.payout.toFixed(2)} USDT`;
                payoutColorClass = 'text-green-400'; 
                iconClass = 'fa-check-circle';
            } else if (bet.status === 'LOSE') {
                statusColorClass = 'text-red-400'; 
                payoutText = `${bet.payout.toFixed(2)} USDT`; // Thường là 0
                payoutColorClass = 'text-red-400'; 
                iconClass = 'fa-bomb'; // Icon bomb cho Mines
            }
            
            const betTime = new Date(bet.placedAt).toLocaleString('vi-VN');
            
            row.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center ${statusColorClass} bg-[var(--border-color)] text-xl flex-shrink-0">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="flex-grow min-w-0">
                    <p class="text-sm font-semibold text-white truncate">Cược: ${bet.betAmount.toFixed(2)} USDT</p>
                    <p class="text-xs text-gray-400">${betTime}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="text-sm font-bold ${payoutColorClass} truncate">${payoutText}</p>
                    <p class="text-xs ${statusColorClass}">${bet.resultNumber || bet.status}</p>
                </div>`;
            return row;
        }

    </script>
</body>
</html>